import { router } from '@kit.ArkUI';
import { BusinessError } from '@kit.BasicServicesKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { common } from '@kit.AbilityKit';
import { RecordState, AudioRecord, RecordResult } from '../model/DataModel';
import { AudioRecordInput } from '../service/DatabaseService';
import { AudioRecorderService } from '../service/AudioRecorderService';
import { DatabaseService } from '../service/DatabaseService';
import { promptAction } from '@kit.ArkUI';

const DOMAIN = 0x0000;

@Entry
@Component
struct RecordPage {
  @State recordState: RecordState = RecordState.IDLE;
  @State recordDuration: number = 0;
  @State fileName: string = '';
  @State isShowFileNameDialog: boolean = false;
  @State waveformData: number[] = [];
  @State currentAmplitude: number = 0;
  @State maxAmplitude: number = 100;
  @State isShowPermissionDialog: boolean = false;
  @State permissionMessage: string = '';
  @State isInitializing: boolean = false;
  
  // ğŸ”¥ æ–°å¢ï¼šä¿å­˜åœæ­¢å½•éŸ³åçš„ç»“æœæ•°æ®
  private savedRecordResult: RecordResult | null = null;
  
  private audioRecorderService = AudioRecorderService.getInstance();
  private databaseService = DatabaseService.getInstance();
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext;
  private updateTimer: number | null = null;

  async aboutToAppear(): Promise<void> {
    hilog.info(DOMAIN, 'RecordPage', 'Page aboutToAppear');
    await this.initializeRecorder();
  }

  aboutToDisappear(): void {
    hilog.info(DOMAIN, 'RecordPage', 'Page aboutToDisappear');
    this.stopUpdateTimer();
    this.audioRecorderService.release();
  }

  /**
   * åˆå§‹åŒ–å½•éŸ³å™¨
   */
  private async initializeRecorder(): Promise<void> {
    this.isInitializing = true;
    
    try {
      hilog.info(DOMAIN, 'RecordPage', 'Starting recorder initialization...');
      
      // åˆå§‹åŒ–å½•éŸ³æœåŠ¡
      await this.audioRecorderService.initialize(this.context);
      
      // è®¾ç½®çŠ¶æ€å˜åŒ–å›è°ƒ
      this.audioRecorderService.setStateChangeCallback((state: RecordState) => {
        const previousState = this.recordState;
        this.recordState = state;
        hilog.info(DOMAIN, 'RecordPage', `Record state changed from ${previousState} to: ${state}`);
        
        // å¤„ç†çŠ¶æ€å˜åŒ–çš„ç‰¹æ®Šé€»è¾‘
        if (state === RecordState.STOPPED) {
          hilog.info(DOMAIN, 'RecordPage', 'Recording stopped via state change callback');
          // åœæ­¢è®¡æ—¶å™¨
          this.stopUpdateTimer();
          // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œæ˜¾ç¤ºå¯¹è¯æ¡†ï¼Œå› ä¸ºsavedRecordResultè¿˜æ²¡æœ‰è®¾ç½®
          // å¯¹è¯æ¡†å°†åœ¨stopRecordingæ–¹æ³•ä¸­æ˜¾ç¤º
        }
      });

      // è®¾ç½®æ—¶é•¿æ›´æ–°å›è°ƒ
      this.audioRecorderService.setDurationCallback((duration: number) => {
        this.recordDuration = duration;
      });

      // è®¾ç½®æŒ¯å¹…å›è°ƒ
      this.audioRecorderService.setAmplitudeCallback((amplitude: number) => {
        this.currentAmplitude = amplitude;
        this.updateWaveform(amplitude);
      });

      // è®¾ç½®é”™è¯¯å›è°ƒ
      this.audioRecorderService.setErrorCallback((error: string) => {
        hilog.error(DOMAIN, 'RecordPage', `Recorder error: ${error}`);
        this.showToast(`å½•éŸ³é”™è¯¯: ${error}`);
      });

      // åˆå§‹åŒ–æ•°æ®åº“
      await this.databaseService.initDatabase(this.context);
      
      hilog.info(DOMAIN, 'RecordPage', 'Recorder initialized successfully');
      this.showToast('å½•éŸ³å™¨åˆå§‹åŒ–æˆåŠŸ');
      
    } catch (error) {
      hilog.error(DOMAIN, 'RecordPage', `Failed to initialize recorder: ${JSON.stringify(error)}`);
      
      const errorMessage = error instanceof Error ? error.message : String(error);
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯æƒé™ç›¸å…³é”™è¯¯
      if (errorMessage.includes('permission') || errorMessage.includes('æƒé™')) {
        this.permissionMessage = 'Recording requires microphone permission, please grant permission in settings';
        this.isShowPermissionDialog = true;
      } else {
        this.showToast(`Failed to initialize recorder: ${errorMessage}`);
      }
    } finally {
      this.isInitializing = false;
    }
  }
  
  /**
   * é‡æ–°åˆå§‹åŒ–å½•éŸ³å™¨
   */
  private async retryInitialize(): Promise<void> {
    this.isShowPermissionDialog = false;
    await this.initializeRecorder();
  }

  /**
   * å¼€å§‹å½•éŸ³
   */
  private async startRecording(): Promise<void> {
    try {
      await this.audioRecorderService.startRecording();
      this.startUpdateTimer();
      this.waveformData = [];
      hilog.info(DOMAIN, 'RecordPage', 'Recording started');
    } catch (error) {
      hilog.error(DOMAIN, 'RecordPage', `Failed to start recording: ${JSON.stringify(error)}`);
      this.showToast('Failed to start recording');
    }
  }

  /**
   * æš‚åœå½•éŸ³
   */
  private async pauseRecording(): Promise<void> {
    try {
      await this.audioRecorderService.pauseRecording();
      this.stopUpdateTimer();
      hilog.info(DOMAIN, 'RecordPage', 'Recording paused');
    } catch (error) {
      hilog.error(DOMAIN, 'RecordPage', `Failed to pause recording: ${JSON.stringify(error)}`);
      this.showToast('Failed to pause recording');
    }
  }

  /**
   * æ¢å¤å½•éŸ³
   */
  private async resumeRecording(): Promise<void> {
    try {
      await this.audioRecorderService.resumeRecording();
      this.startUpdateTimer();
      hilog.info(DOMAIN, 'RecordPage', 'Recording resumed');
    } catch (error) {
      hilog.error(DOMAIN, 'RecordPage', `Failed to resume recording: ${JSON.stringify(error)}`);
      this.showToast('Failed to resume recording');
    }
  }

  /**
   * åœæ­¢å½•éŸ³
   */
  private async stopRecording(): Promise<void> {
    const timestamp = new Date().toISOString();
    hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ========== stopRecording() started ==========`);
    const currentState = this.recordState;
    hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] Current recording state: ${currentState}`);
    hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] Current recording duration: ${this.recordDuration}ms`);
    
    // ğŸ”¥ å…³é”®ä¿®å¤ï¼šç«‹å³æ›´æ–°çŠ¶æ€ä¸ºSTOPPEDï¼Œç¡®ä¿UIç«‹å³å“åº”
    this.recordState = RecordState.STOPPED;
    hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] âœ… Recording state immediately set to STOPPED`);
    
    try {
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] Calling audioRecorderService.stopRecording()`);
      const audioRecord = await this.audioRecorderService.stopRecording();
      
      // è¯¦ç»†æ£€æŸ¥è¿”å›å€¼
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] audioRecorderService.stopRecording() return type: ${typeof audioRecord}`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] audioRecorderService.stopRecording() result: ${JSON.stringify(audioRecord)}`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] audioRecord is truthy: ${!!audioRecord}`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] audioRecord is null: ${audioRecord === null}`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] audioRecord is undefined: ${audioRecord === undefined}`);
      
      if (audioRecord) {
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] audioRecord.filePath: ${audioRecord.filePath}`);
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] audioRecord.duration: ${audioRecord.duration}`);
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] audioRecord.fileSize: ${audioRecord.fileSize}`);
      }
      
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] Calling stopUpdateTimer()`);
      this.stopUpdateTimer();
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] stopUpdateTimer() completed`);
      
      if (audioRecord) {
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] audioRecord exists, preparing to show filename dialog`);
        
        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šä¿å­˜RecordResultæ•°æ®ä¾›saveRecordingä½¿ç”¨
        this.savedRecordResult = audioRecord;
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ’¾ RecordResult data saved:`);
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] - savedRecordResult.filePath: '${this.savedRecordResult.filePath}'`);
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] - savedRecordResult.duration: ${this.savedRecordResult.duration}ms`);
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] - savedRecordResult.fileSize: ${this.savedRecordResult.fileSize} bytes`);
        
        // ç”Ÿæˆé»˜è®¤æ–‡ä»¶å
        this.fileName = this.generateDefaultFileName();
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] Generated default filename: ${this.fileName}`);
        
        // æ˜¾ç¤ºæ–‡ä»¶åè¾“å…¥å¯¹è¯æ¡†
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] Setting isShowFileNameDialog from ${this.isShowFileNameDialog} to true`);
        this.isShowFileNameDialog = true;
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] isShowFileNameDialog current value: ${this.isShowFileNameDialog}`);
        
        // å¼ºåˆ¶UIæ›´æ–°
        setTimeout(() => {
          hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] Delayed check - isShowFileNameDialog: ${this.isShowFileNameDialog}`);
        }, 100);
        
      } else {
        hilog.warn(DOMAIN, 'RecordPage', `[${timestamp}] âŒ audioRecord is null or undefined, cannot show dialog`);
        hilog.warn(DOMAIN, 'RecordPage', `[${timestamp}] This might be the reason for UI staying`);
        this.savedRecordResult = null;
        this.showToast('Failed to get recording data');
      }
      
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ========== stopRecording() completed ==========`);
    } catch (error) {
      hilog.error(DOMAIN, 'RecordPage', `[${timestamp}] âŒ stopRecording() failed: ${JSON.stringify(error)}`);
      hilog.error(DOMAIN, 'RecordPage', `[${timestamp}] Error stack: ${error instanceof Error ? error.stack : 'No stack trace'}`);
      this.showToast('Failed to stop recording');
    }
  }

  /**
   * å–æ¶ˆå½•éŸ³
   */
  private async cancelRecording(): Promise<void> {
    try {
      await this.audioRecorderService.cancelRecording();
      this.stopUpdateTimer();
      this.waveformData = [];
      this.recordDuration = 0;
      hilog.info(DOMAIN, 'RecordPage', 'Recording cancelled');
    } catch (error) {
      hilog.error(DOMAIN, 'RecordPage', `Failed to cancel recording: ${JSON.stringify(error)}`);
      this.showToast('å–æ¶ˆå½•éŸ³å¤±è´¥');
    }
  }

  /**
   * è‡ªåŠ¨ä¿å­˜å½•éŸ³ï¼ˆä¸æ˜¾ç¤ºå¯¹è¯æ¡†ï¼‰- å·²ç¦ç”¨ï¼Œé¿å…é‡å¤ä¿å­˜
   */
  private async autoSaveRecording(): Promise<void> {
    const timestamp = new Date().toISOString();
    hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] âš ï¸ autoSaveRecording() called but disabled to prevent duplicate saves`);
    // æ­¤æ–¹æ³•å·²ç¦ç”¨ï¼Œé¿å…ä¸ç”¨æˆ·æ‰‹åŠ¨ä¿å­˜é‡å¤
    // å½•éŸ³æ•°æ®å·²åœ¨stopRecording()ä¸­ä¿å­˜åˆ°savedRecordResult
    // ç”¨æˆ·éœ€è¦é€šè¿‡ç‚¹å‡»"å®Œæˆ"æŒ‰é’®æ¥ä¿å­˜å½•éŸ³
  }

  /**
   * ä¿å­˜å½•éŸ³
   */
  private async saveRecording(): Promise<void> {
    const timestamp = new Date().toISOString();
    hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ¯ Starting recording save process`);
    hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] Input filename: '${this.fileName}'`);
    hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] audioRecorderService status: ${this.audioRecorderService ? 'initialized' : 'not initialized'}`);
    
    if (!this.fileName.trim()) {
      hilog.warn(DOMAIN, 'RecordPage', `[${timestamp}] âŒ æ–‡ä»¶åä¸ºç©ºï¼Œæ— æ³•ä¿å­˜`);
      this.showToast('è¯·è¾“å…¥æ–‡ä»¶å');
      return;
    }

    try {
      const timestamp = new Date().toISOString();
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ¯ å¼€å§‹ä¿å­˜å½•éŸ³ï¼Œæ–‡ä»¶å: ${this.fileName}`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ“Š å½•éŸ³æ•°æ®è¯¦æƒ…: æ—¶é•¿=${this.savedRecordResult?.duration}ms, æ–‡ä»¶å¤§å°=${this.savedRecordResult?.fileSize}å­—èŠ‚`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ“‚ æ–‡ä»¶è·¯å¾„: ${this.savedRecordResult?.filePath}`);
      
      // ğŸ”¥ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ä¿å­˜çš„RecordResultæ•°æ®è€Œä¸æ˜¯é‡æ–°è·å–
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ” æ£€æŸ¥ä¿å­˜çš„RecordResultæ•°æ®`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] savedRecordResultæ˜¯å¦å­˜åœ¨: ${!!this.savedRecordResult}`);
      
      if (!this.savedRecordResult) {
        hilog.error(DOMAIN, 'RecordPage', `[${timestamp}] âŒ savedRecordResultä¸ºç©ºï¼Œæ— æ³•ä¿å­˜`);
        this.showToast('å½•éŸ³æ•°æ®ä¸¢å¤±ï¼Œè¯·é‡æ–°å½•éŸ³');
        return;
      }
      
      const filePath = this.savedRecordResult.filePath;
      const duration = this.savedRecordResult.duration;
      const fileSize = this.savedRecordResult.fileSize;
      
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ“ ä½¿ç”¨ä¿å­˜çš„æ–‡ä»¶è·¯å¾„: '${filePath}'`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] â±ï¸ ä½¿ç”¨ä¿å­˜çš„å½•éŸ³æ—¶é•¿: ${duration}ms`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ“Š ä½¿ç”¨ä¿å­˜çš„æ–‡ä»¶å¤§å°: ${fileSize} bytes`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] æ–‡ä»¶è·¯å¾„ç±»å‹: ${typeof filePath}`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] æ–‡ä»¶è·¯å¾„æ˜¯å¦ä¸ºç©º: ${!filePath}`);
      
      // éªŒè¯å…³é”®æ•°æ®
      if (!filePath) {
        hilog.error(DOMAIN, 'RecordPage', `[${timestamp}] âŒ ä¿å­˜çš„æ–‡ä»¶è·¯å¾„ä¸ºç©ºï¼Œæ— æ³•ä¿å­˜`);
        this.showToast('å½•éŸ³æ–‡ä»¶è·¯å¾„è·å–å¤±è´¥');
        return;
      }
      
      if (duration <= 0) {
        hilog.warn(DOMAIN, 'RecordPage', `[${timestamp}] âš ï¸ ä¿å­˜çš„å½•éŸ³æ—¶é•¿å¼‚å¸¸: ${duration}ms`);
      }

      // åˆ›å»ºéŸ³é¢‘è®°å½•å¯¹è±¡
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ“ åˆ›å»ºéŸ³é¢‘è®°å½•å¯¹è±¡`);
      const audioRecord: AudioRecordInput = {
        fileName: this.fileName.trim(),
        filePath: filePath,
        duration: duration,
        fileSize: fileSize, // ğŸ”¥ ä½¿ç”¨ä¿å­˜çš„å®é™…æ–‡ä»¶å¤§å°
        createTime: Date.now(),
        isTop: false,
        groupId: 0 // 0è¡¨ç¤ºæœªåˆ†ç»„
      };
      
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] éŸ³é¢‘è®°å½•å¯¹è±¡è¯¦æƒ…:`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}]   - æ–‡ä»¶å: '${audioRecord.fileName}'`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}]   - æ–‡ä»¶è·¯å¾„: '${audioRecord.filePath}'`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}]   - æ—¶é•¿: ${audioRecord.duration}ms`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}]   - æ–‡ä»¶å¤§å°: ${audioRecord.fileSize}å­—èŠ‚`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}]   - åˆ›å»ºæ—¶é—´: ${new Date(audioRecord.createTime).toLocaleString()}`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}]   - åˆ†ç»„ID: ${audioRecord.groupId}`);

      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ”„ æ­£åœ¨è°ƒç”¨æ•°æ®åº“ä¿å­˜æ–¹æ³•...`);
      
      // ä¿å­˜åˆ°æ•°æ®åº“
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ’¾ å¼€å§‹ä¿å­˜åˆ°æ•°æ®åº“`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] databaseService status: ${this.databaseService ? 'initialized' : 'not initialized'}`);
      
      const result = await this.databaseService.insertAudioRecord(audioRecord);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] æ•°æ®åº“ä¿å­˜ç»“æœ: ${result}`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ç»“æœç±»å‹: ${typeof result}`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ“Š æ•°æ®åº“ä¿å­˜ç»“æœ: ${result > 0 ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
      
      if (result > 0) {
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] âœ… å½•éŸ³ä¿å­˜æˆåŠŸï¼Œè®°å½•ID: ${result}`);
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] âœ… å½•éŸ³ä¿å­˜æˆåŠŸï¼å‡†å¤‡è·³è½¬å›ä¸»é¡µé¢`);
        this.showToast('å½•éŸ³ä¿å­˜æˆåŠŸ');
        
        // ğŸ”¥ æ¸…ç©ºä¿å­˜çš„å½•éŸ³æ•°æ®ï¼Œä¸ºä¸‹æ¬¡å½•éŸ³åšå‡†å¤‡
        this.savedRecordResult = null;
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ§¹ å·²æ¸…ç©ºsavedRecordResult`);
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ§¹ å·²æ¸…ç©ºä¿å­˜çš„å½•éŸ³æ•°æ®`);
        
        // å…³é—­å¯¹è¯æ¡†
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ”’ å…³é—­æ–‡ä»¶åå¯¹è¯æ¡†`);
        this.isShowFileNameDialog = false;
        this.fileName = '';
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] å¯¹è¯æ¡†çŠ¶æ€å·²æ›´æ–°: isShowFileNameDialog=${this.isShowFileNameDialog}`);
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸšª å·²å…³é—­æ–‡ä»¶åå¯¹è¯æ¡†`);
        
        // è¿”å›ä¸»é¡µé¢
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ  å‡†å¤‡è·³è½¬å›ä¸»é¡µé¢`);
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] è°ƒç”¨ router.back() å‰çš„çŠ¶æ€æ£€æŸ¥å®Œæˆ`);
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] â° å‡†å¤‡åœ¨1000msåè·³è½¬å›ä¸»é¡µé¢`);
        
        setTimeout(() => {
          hilog.info(DOMAIN, 'RecordPage', `[${new Date().toISOString()}] ğŸš€ å¼€å§‹è·³è½¬å›ä¸»é¡µé¢`);
          hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] æ‰§è¡Œé¡µé¢è¿”å›`);
          this.navigateBack();
        }, 1000);
        
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] âœ… å·²è®¾ç½®å»¶æ—¶è·³è½¬ï¼Œé¡µé¢è·³è½¬æŒ‡ä»¤å·²å‘å‡º`);
      } else {
        hilog.error(DOMAIN, 'RecordPage', `[${timestamp}] âŒ æ•°æ®åº“ä¿å­˜å¤±è´¥ï¼Œè¿”å›å€¼: ${result}`);
        hilog.error(DOMAIN, 'RecordPage', `[${timestamp}] âŒ å½•éŸ³ä¿å­˜å¤±è´¥`);
        this.showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    } catch (error) {
      const timestamp = new Date().toISOString();
      hilog.error(DOMAIN, 'RecordPage', `[${timestamp}] âŒ ä¿å­˜å½•éŸ³æ—¶å‘ç”Ÿé”™è¯¯:`);
      hilog.error(DOMAIN, 'RecordPage', `[${timestamp}] Error message: ${error instanceof Error ? error.message : String(error)}`);
      hilog.error(DOMAIN, 'RecordPage', `[${timestamp}] é”™è¯¯å †æ ˆ: ${error instanceof Error ? error.stack : 'No stack trace'}`);
      hilog.error(DOMAIN, 'RecordPage', `[${timestamp}] âŒ ä¿å­˜å½•éŸ³æ—¶å‘ç”Ÿé”™è¯¯: ${JSON.stringify(error)}`);
      this.showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  /**
   * ç”Ÿæˆé»˜è®¤æ–‡ä»¶å
   */
  private generateDefaultFileName(): string {
    const now = new Date();
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const hour = now.getHours().toString().padStart(2, '0');
    const minute = now.getMinutes().toString().padStart(2, '0');
    const second = now.getSeconds().toString().padStart(2, '0');
    
    return `å½•éŸ³_${year}${month}${day}_${hour}${minute}${second}`;
  }

  /**
   * æ›´æ–°æ³¢å½¢æ•°æ®
   */
  private updateWaveform(amplitude: number): void {
    // å°†æŒ¯å¹…å€¼æ·»åŠ åˆ°æ³¢å½¢æ•°æ®ä¸­
    this.waveformData.push(amplitude);
    
    // é™åˆ¶æ³¢å½¢æ•°æ®é•¿åº¦ï¼Œä¿æŒæœ€è¿‘çš„120ä¸ªæ•°æ®ç‚¹ï¼ˆæ›´å¤šæ•°æ®ç‚¹ä½¿æ³¢å½¢æ›´å¹³æ»‘ï¼‰
    if (this.waveformData.length > 120) {
      this.waveformData.shift();
    }
    
    // åŠ¨æ€è°ƒæ•´æœ€å¤§æŒ¯å¹…ï¼Œä½¿æ³¢å½¢æ˜¾ç¤ºæ›´è‡ªç„¶
    const currentMaxInData = Math.max(...this.waveformData);
    if (currentMaxInData > this.maxAmplitude) {
      this.maxAmplitude = currentMaxInData;
    } else if (currentMaxInData < this.maxAmplitude * 0.8) {
      // å¦‚æœå½“å‰æœ€å¤§å€¼æ˜æ˜¾å°äºå†å²æœ€å¤§å€¼ï¼Œé€æ¸é™ä½æœ€å¤§å€¼
      this.maxAmplitude = Math.max(currentMaxInData * 1.2, 20); // ä¿æŒæœ€å°é«˜åº¦
    }
  }

  /**
   * å¼€å§‹æ›´æ–°å®šæ—¶å™¨
   */
  private startUpdateTimer(): void {
    this.stopUpdateTimer();
    this.updateTimer = setInterval(() => {
      // å®šæ—¶å™¨ç”¨äºè§¦å‘UIæ›´æ–°ï¼Œå®é™…æ•°æ®é€šè¿‡å›è°ƒæ›´æ–°
    }, 100);
  }

  /**
   * åœæ­¢æ›´æ–°å®šæ—¶å™¨
   */
  private stopUpdateTimer(): void {
    if (this.updateTimer) {
      clearInterval(this.updateTimer);
      this.updateTimer = null;
    }
  }

  /**
   * æ ¼å¼åŒ–æ—¶é•¿æ˜¾ç¤º
   */
  private formatDuration(duration: number): string {
    const totalSeconds = Math.floor(duration / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    const milliseconds = Math.floor((duration % 1000) / 10);
    
    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}`;
  }

  /**
   * æ˜¾ç¤ºæç¤ºä¿¡æ¯
   */
  private showToast(message: string): void {
    promptAction.showToast({
      message: message,
      duration: 2000
    });
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  private navigateBack(): void {
    const timestamp = new Date().toISOString();
    hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ”„ navigateBack() å¼€å§‹æ‰§è¡Œ`);
    hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] å½“å‰é¡µé¢çŠ¶æ€æ£€æŸ¥:`);
    const currentState = this.recordState;
    hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] - recordState: ${currentState}`);
    hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] - isShowFileNameDialog: ${this.isShowFileNameDialog}`);
    hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] - fileName: '${this.fileName}'`);
    
    try {
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] Preparing to call router.back()`);
      const routerStatus = 'available';
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] router object status: ${routerStatus}`);
      
      router.back();
      
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] router.back() called successfully`);
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] Page navigation command issued, waiting for system processing`);
      
      // æ·»åŠ å»¶æ—¶æ£€æŸ¥ï¼Œç¡®è®¤é¡µé¢æ˜¯å¦çœŸçš„è·³è½¬äº†
      setTimeout(() => {
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] Delayed check: page navigation status`);
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] If you see this log, the page may not have navigated successfully`);
      }, 2000);
      
    } catch (error) {
      hilog.error(DOMAIN, 'RecordPage', `[${timestamp}] navigateBack() execution failed:`);
      hilog.error(DOMAIN, 'RecordPage', `[${timestamp}] é”™è¯¯ä¿¡æ¯: ${error instanceof Error ? error.message : String(error)}`);
      hilog.error(DOMAIN, 'RecordPage', `[${timestamp}] é”™è¯¯å †æ ˆ: ${error instanceof Error ? error.stack : 'No stack trace'}`);
      
      // å¦‚æœrouter.back()å¤±è´¥ï¼Œå°è¯•å…¶ä»–è·³è½¬æ–¹å¼
      hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] Trying alternative navigation method`);
      try {
        router.replaceUrl({ url: 'pages/Index' });
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] Successfully navigated using router.replaceUrl()`);
      } catch (replaceError) {
        hilog.error(DOMAIN, 'RecordPage', `[${timestamp}] Alternative navigation method also failed: ${replaceError instanceof Error ? replaceError.message : String(replaceError)}`);
      }
    }
  }

  /**
   * è·å–å½•éŸ³æŒ‰é’®æ–‡æœ¬
   */
  private getRecordButtonText(): string {
    switch (this.recordState) {
      case RecordState.IDLE:
        return 'å¼€å§‹å½•éŸ³';
      case RecordState.RECORDING:
        return 'æš‚åœ';
      case RecordState.PAUSED:
        return 'ç»§ç»­';
      case RecordState.STOPPED:
        return 'é‡æ–°å½•éŸ³';
      default:
        return 'å½•éŸ³';
    }
  }

  /**
   * è·å–å½•éŸ³æŒ‰é’®é¢œè‰²
   */
  private getRecordButtonColor(): string {
    switch (this.recordState) {
      case RecordState.RECORDING:
        return '#FF3B30';
      case RecordState.PAUSED:
        return '#FF9500';
      default:
        return '#007AFF';
    }
  }

  /**
   * è·å–æ³¢å½¢æ¡é¢œè‰²
   */
  private getWaveformBarColor(amplitude: number, index: number): string {
    if (this.recordState !== RecordState.RECORDING) {
      return '#D0D0D0';
    }
    
    // æ ¹æ®æŒ¯å¹…å¼ºåº¦è®¾ç½®é¢œè‰²æ¸å˜
    const intensity = amplitude / this.maxAmplitude;
    
    if (intensity > 0.8) {
      return '#FF3B30'; // é«˜æŒ¯å¹…ï¼šçº¢è‰²
    } else if (intensity > 0.6) {
      return '#FF9500'; // ä¸­é«˜æŒ¯å¹…ï¼šæ©™è‰²
    } else if (intensity > 0.3) {
      return '#007AFF'; // ä¸­æŒ¯å¹…ï¼šè“è‰²
    } else {
      return '#34C759'; // ä½æŒ¯å¹…ï¼šç»¿è‰²
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Image($r('app.media.icon'))
            .width(20)
            .height(20)
            .fillColor('#333333')
        }
        .width(40)
        .height(40)
        .backgroundColor('transparent')
        .onClick(() => this.navigateBack())
        
        Text('å½•éŸ³')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
        Row()
          .width(40)
          .height(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')

      // å½•éŸ³æ—¶é•¿æ˜¾ç¤º
      Column() {
        Text(this.formatDuration(this.recordDuration))
          .fontSize(48)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .margin({ top: 40, bottom: 20 })
        
        Text(this.recordState === RecordState.RECORDING ? 'Recording...' : 
             this.recordState === RecordState.PAUSED ? 'Recording Paused' : 
             this.recordState === RecordState.STOPPED ? 'Recording Completed' : 'Ready to Record')
          .fontSize(16)
          .fontColor('#666666')
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)

      // æ³¢å½¢æ˜¾ç¤ºåŒºåŸŸ
      Column() {
        Text('éŸ³é¢‘æ³¢å½¢')
          .fontSize(14)
          .fontColor('#999999')
          .margin({ bottom: 16 })
        
        // æ³¢å½¢å®¹å™¨
        Row() {
          ForEach(this.waveformData, (amplitude: number, index: number) => {
            Column()
              .width(2)
              .height(Math.max(4, (amplitude / this.maxAmplitude) * 80))
              .backgroundColor(this.getWaveformBarColor(amplitude, index))
              .borderRadius(1)
              .margin({ left: 0.5, right: 0.5 })
              .animation({
                duration: 100,
                curve: Curve.EaseOut
              })
          })
        }
        .width('100%')
        .height(100)
        .justifyContent(FlexAlign.Center)
        .alignItems(VerticalAlign.Bottom)
        .backgroundColor('#F0F0F0')
        .borderRadius(12)
        .padding({ left: 12, right: 12, top: 20, bottom: 20 })
        .border({ width: 1, color: '#E0E0E0' })
      }
      .width('100%')
      .padding({ left: 24, right: 24, top: 40, bottom: 40 })
      .layoutWeight(1)

      // æ§åˆ¶æŒ‰é’®åŒºåŸŸ
      Row() {
        // å–æ¶ˆæŒ‰é’®
        if (this.recordState !== RecordState.IDLE) {
          Button('å–æ¶ˆ')
            .fontSize(16)
            .fontColor('#FF3B30')
            .backgroundColor('#FFFFFF')
            .border({ width: 1, color: '#FF3B30' })
            .borderRadius(25)
            .width(80)
            .height(50)
            .onClick(() => this.cancelRecording())
        }
        
        Blank()
        
        // ä¸»å½•éŸ³æŒ‰é’®
        Button() {
          Column() {
            if (this.isInitializing) {
              LoadingProgress()
                .width(40)
                .height(40)
                .color('#FFFFFF')
            } else if (this.recordState === RecordState.RECORDING) {
              // å½•éŸ³ä¸­æ˜¾ç¤ºæš‚åœå›¾æ ‡
              Row()
                .width(20)
                .height(20)
                .backgroundColor('#FFFFFF')
                .borderRadius(2)
            } else {
              // å…¶ä»–çŠ¶æ€æ˜¾ç¤ºå½•éŸ³å›¾æ ‡
              Circle()
                .width(24)
                .height(24)
                .fill('#FFFFFF')
            }
          }
        }
        .width(80)
        .height(80)
        .backgroundColor(this.getRecordButtonColor())
        .borderRadius(40)
        .enabled(!this.isInitializing)
        .onClick(() => {
          if (this.isInitializing) {
            this.showToast('æ­£åœ¨åˆå§‹åŒ–å½•éŸ³å™¨ï¼Œè¯·ç¨å€™...');
            return;
          }
          
          switch (this.recordState) {
            case RecordState.IDLE:
            case RecordState.STOPPED:
              this.startRecording();
              break;
            case RecordState.RECORDING:
              this.pauseRecording();
              break;
            case RecordState.PAUSED:
              this.resumeRecording();
              break;
          }
        })
        
        Blank()
        
        // åœæ­¢æŒ‰é’®
        if (this.recordState === RecordState.RECORDING || this.recordState === RecordState.PAUSED) {
          Button('å®Œæˆ')
            .fontSize(16)
            .fontColor('#007AFF')
            .backgroundColor('#FFFFFF')
            .border({ width: 1, color: '#007AFF' })
            .borderRadius(25)
            .width(80)
            .height(50)
            .onClick(() => {
              const timestamp = new Date().toISOString();
              hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ¯ ========== å®ŒæˆæŒ‰é’®è¢«ç‚¹å‡» ==========`);
              hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ“Š å½“å‰å½•éŸ³çŠ¶æ€: ${this.recordState}`);
              hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] â±ï¸ å½“å‰å½•éŸ³æ—¶é•¿: ${this.recordDuration}ms (${this.formatDuration(this.recordDuration)})`);
              hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ”Š å½“å‰æŒ¯å¹…: ${this.currentAmplitude}`);
              hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ“ˆ æ³¢å½¢æ•°æ®ç‚¹æ•°: ${this.waveformData.length}`);
              hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ’¾ å·²ä¿å­˜çš„å½•éŸ³ç»“æœ: ${this.savedRecordResult ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
              if (this.savedRecordResult) {
                hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ“‚ ä¿å­˜çš„æ–‡ä»¶è·¯å¾„: '${this.savedRecordResult.filePath}'`);
                hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] â±ï¸ ä¿å­˜çš„æ—¶é•¿: ${this.savedRecordResult.duration}ms`);
                hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ“Š ä¿å­˜çš„æ–‡ä»¶å¤§å°: ${this.savedRecordResult.fileSize} bytes`);
              }
              hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸš€ å¼€å§‹è°ƒç”¨ stopRecording() æ–¹æ³•`);
              this.stopRecording();
            })
        }
      }
      .width('100%')
      .padding({ left: 40, right: 40, bottom: 40 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F8F8')
    .bindContentCover(this.isShowFileNameDialog, this.FileNameDialog(), {
      modalTransition: ModalTransition.NONE,
      backgroundColor: '#80000000',
      onAppear: () => {
        const timestamp = new Date().toISOString();
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] âœ… æ–‡ä»¶åå¯¹è¯æ¡†å·²æ˜¾ç¤º`);
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] isShowFileNameDialog: ${this.isShowFileNameDialog}`);
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] fileName: ${this.fileName}`);
      },
      onDisappear: () => {
        const timestamp = new Date().toISOString();
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] âŒ æ–‡ä»¶åå¯¹è¯æ¡†å·²éšè—`);
        hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] isShowFileNameDialog: ${this.isShowFileNameDialog}`);
      }
    })
    .bindContentCover(this.isShowPermissionDialog, this.PermissionDialog(), {
      modalTransition: ModalTransition.NONE,
      backgroundColor: '#80000000',
      onAppear: () => {
        hilog.info(DOMAIN, 'RecordPage', 'Permission dialog appeared');
      }
    })
  }

  // æ–‡ä»¶åè¾“å…¥å¯¹è¯æ¡†
  @Builder
  FileNameDialog() {
    Column() {
      Text('ä¿å­˜å½•éŸ³')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 20 })

      TextInput({ placeholder: 'è¯·è¾“å…¥æ–‡ä»¶å', text: this.fileName })
        .width('100%')
        .height(40)
        .margin({ bottom: 20 })
        .onChange((value: string) => {
          this.fileName = value;
        })

      Row() {
        Button('å–æ¶ˆ')
          .width('45%')
          .height(40)
          .backgroundColor('#E0E0E0')
          .fontColor('#333333')
          .onClick(() => {
            const timestamp = new Date().toISOString();
            hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸš« ç”¨æˆ·ç‚¹å‡»å–æ¶ˆæŒ‰é’®`);
            this.isShowFileNameDialog = false;
            this.fileName = '';
            hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] å¯¹è¯æ¡†å·²å…³é—­ï¼Œæ–‡ä»¶åå·²æ¸…ç©º`);
          })

        Button('ä¿å­˜')
          .width('45%')
          .height(40)
          .backgroundColor('#007AFF')
          .fontColor('#FFFFFF')
          .onClick(async () => {
            const timestamp = new Date().toISOString();
            hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] ğŸ’¾ ç”¨æˆ·ç‚¹å‡»ä¿å­˜æŒ‰é’®`);
            hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] å½“å‰æ–‡ä»¶å: '${this.fileName}'`);
            hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] æ–‡ä»¶åtrimå: '${this.fileName.trim()}'`);
            
            if (this.fileName.trim()) {
              hilog.info(DOMAIN, 'RecordPage', `[${timestamp}] æ–‡ä»¶åæœ‰æ•ˆï¼Œå¼€å§‹è°ƒç”¨ saveRecording()`);
              await this.saveRecording();
            } else {
              hilog.warn(DOMAIN, 'RecordPage', `[${timestamp}] æ–‡ä»¶åä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯`);
              this.showToast('è¯·è¾“å…¥æ–‡ä»¶å');
            }
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width('80%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(10)
    .shadow({ radius: 10, color: '#00000020' })
  }
  
  @Builder
  PermissionDialog() {
    Column() {
      Text('æƒé™è¯·æ±‚')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 20 })
        .fontColor('#333333')

      Text(this.permissionMessage)
        .fontSize(16)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)
        .margin({ bottom: 30 })
        .lineHeight(24)

      Row() {
        Button('å–æ¶ˆ')
          .width('45%')
          .height(40)
          .backgroundColor('#E0E0E0')
          .fontColor('#333333')
          .onClick(() => {
            this.isShowPermissionDialog = false;
            router.back();
          })

        Button('é‡è¯•')
          .width('45%')
          .height(40)
          .backgroundColor('#007AFF')
          .fontColor('#FFFFFF')
          .onClick(async () => {
            await this.retryInitialize();
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width('80%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(10)
    .shadow({ radius: 10, color: '#00000020' })
  }
}

// è‡ªå®šä¹‰å¯¹è¯æ¡†ç»„ä»¶
@CustomDialog
struct FileNameDialogComponent {
  @State fileName: string = '';
  controller: CustomDialogController = new CustomDialogController({builder: () => {}});
  onConfirm?: (fileName: string) => void;
  onCancel?: () => void;

  build() {
    Column() {
      Text('ä¿å­˜å½•éŸ³')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .margin({ bottom: 20 })
      
      TextInput({ placeholder: 'è¯·è¾“å…¥æ–‡ä»¶å', text: this.fileName })
        .width('100%')
        .height(40)
        .backgroundColor('#F8F8F8')
        .borderRadius(8)
        .padding({ left: 12, right: 12 })
        .margin({ bottom: 20 })
        .onChange((value: string) => {
          this.fileName = value;
        })
      
      Row() {
        Button('å–æ¶ˆ')
          .fontSize(16)
          .fontColor('#666666')
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .width(80)
          .height(40)
          .onClick(() => {
            this.controller.close();
            if (this.onCancel) {
              this.onCancel();
            }
          })
        
        Blank()
        
        Button('ä¿å­˜')
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor('#007AFF')
          .borderRadius(8)
          .width(80)
          .height(40)
          .onClick(() => {
            if (this.onConfirm) {
              this.onConfirm(this.fileName);
            }
            this.controller.close();
          })
      }
      .width('100%')
    }
    .width(280)
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
  }
}