import { router } from '@kit.ArkUI';
import { BusinessError } from '@kit.BasicServicesKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { common } from '@kit.AbilityKit';
import { fileIo } from '@kit.CoreFileKit';
import { AudioRecord, AudioGroup, PlayState } from '../model/DataModel';
import { AudioPlayerService } from '../service/AudioPlayerService';
import { DatabaseService } from '../service/DatabaseService';
import { promptAction } from '@kit.ArkUI';

const DOMAIN = 0x0000;

// å®šä¹‰å¯¹è¯æ¡†åç§»é‡æ¥å£
interface DialogOffset {
  dx: number;
  dy: number;
}

@Entry
@Component
struct AudioDetailPage {
  @State audioRecord: AudioRecord | null = null;
  @State playState: PlayState = PlayState.IDLE;
  @State currentPosition: number = 0;
  @State totalDuration: number = 0;
  @State volume: number = 50;
  @State playbackSpeed: number = 1.0;
  @State isLoading: boolean = true;
  @State isShowDeleteDialog: boolean = false;
  @State isShowRenameDialog: boolean = false;
  @State isShowGroupDialog: boolean = false;
  @State newFileName: string = '';
  @State availableGroups: AudioGroup[] = [];
  @State selectedGroupId: number = 0;
  
  private audioPlayerService = AudioPlayerService.getInstance();
  private databaseService = DatabaseService.getInstance();
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext;
  private audioId: number = 0;
  private updateTimer: number | null = null;
  private deleteDialogController: CustomDialogController | null = null;
  private renameDialogController: CustomDialogController | null = null;
  private groupDialogController: CustomDialogController | null = null;

  async aboutToAppear(): Promise<void> {
    hilog.info(DOMAIN, 'AudioDetailPage', 'Page aboutToAppear');
    
    // è·å–ä¼ é€’çš„å‚æ•°
    const params = router.getParams() as Record<string, number | string>;
    if (params && params['audioId']) {
      this.audioId = params['audioId'] as number;
      await this.initializePage();
    } else {
      this.showToast('Invalid audio ID');
      this.navigateBack();
    }
  }

  aboutToDisappear(): void {
    hilog.info(DOMAIN, 'AudioDetailPage', 'Page aboutToDisappear');
    this.stopUpdateTimer();
    this.audioPlayerService.stop();
    this.closeAllDialogs();
  }

  /**
   * åˆå§‹åŒ–é¡µé¢
   */
  private async initializePage(): Promise<void> {
    try {
      // åˆå§‹åŒ–æ•°æ®åº“
      await this.databaseService.initDatabase(this.context);
      
      // åŠ è½½éŸ³é¢‘è®°å½•
      await this.loadAudioRecord();
      
      // åˆå§‹åŒ–æ’­æ”¾å™¨
      await this.initializePlayer();
      
      // åŠ è½½åˆ†ç»„åˆ—è¡¨
      await this.loadGroups();
      
    } catch (error) {
      hilog.error(DOMAIN, 'AudioDetailPage', `Failed to initialize page: ${JSON.stringify(error)}`);
      this.showToast('Failed to initialize page');
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * åŠ è½½éŸ³é¢‘è®°å½•
   */
  private async loadAudioRecord(): Promise<void> {
    try {
      this.audioRecord = await this.databaseService.getAudioRecordById(this.audioId);
      if (!this.audioRecord) {
        this.showToast('Audio record does not exist');
        this.navigateBack();
        return;
      }
      
      this.newFileName = this.audioRecord.fileName;
      this.selectedGroupId = this.audioRecord.groupId || 0;
      
      hilog.info(DOMAIN, 'AudioDetailPage', `Loaded audio record: ${this.audioRecord.fileName}`);
    } catch (error) {
      hilog.error(DOMAIN, 'AudioDetailPage', `Failed to load audio record: ${JSON.stringify(error)}`);
      this.showToast('Failed to load audio record');
    }
  }

  /**
   * åˆå§‹åŒ–æ’­æ”¾å™¨
   */
  private async initializePlayer(): Promise<void> {
    try {
      if (!this.audioRecord) return;
      
      // è®¾ç½®çŠ¶æ€å˜åŒ–å›è°ƒ
      this.audioPlayerService.setStateChangeCallback((state: PlayState) => {
        this.playState = state;
      });

      // è®¾ç½®ä½ç½®æ›´æ–°å›è°ƒ
      this.audioPlayerService.setPositionCallback((position: number) => {
        this.currentPosition = position;
      });

      // è®¾ç½®æ—¶é•¿å›è°ƒ
      this.audioPlayerService.setDurationCallback((duration: number) => {
        this.totalDuration = duration;
      });

      // è®¾ç½®é”™è¯¯å›è°ƒ
      this.audioPlayerService.setErrorCallback((error: string) => {
        this.showToast(`Playback error: ${error}`);
      });

      // å‡†å¤‡æ’­æ”¾
      await this.audioPlayerService.prepare(this.audioRecord.filePath);
      
    } catch (error) {
      hilog.error(DOMAIN, 'AudioDetailPage', `Failed to initialize player: ${JSON.stringify(error)}`);
      this.showToast('Failed to initialize player');
    }
  }

  /**
   * åŠ è½½åˆ†ç»„åˆ—è¡¨
   */
  private async loadGroups(): Promise<void> {
    try {
      this.availableGroups = await this.databaseService.getAllGroups();
    } catch (error) {
      hilog.error(DOMAIN, 'AudioDetailPage', `Failed to load groups: ${JSON.stringify(error)}`);
    }
  }

  /**
   * æ’­æ”¾/æš‚åœ
   */
  private async togglePlayPause(): Promise<void> {
    try {
      if (this.playState === PlayState.PLAYING) {
        await this.audioPlayerService.pause();
        this.stopUpdateTimer();
      } else {
        if (this.audioRecord?.filePath) {
          await this.audioPlayerService.play(this.audioRecord.filePath);
          this.startUpdateTimer();
        }
      }
    } catch (error) {
      hilog.error(DOMAIN, 'AudioDetailPage', `Failed to toggle play/pause: ${JSON.stringify(error)}`);
      this.showToast('Playback failed');
    }
  }

  /**
   * åœæ­¢æ’­æ”¾
   */
  private async stopPlayback(): Promise<void> {
    try {
      await this.audioPlayerService.stop();
      this.stopUpdateTimer();
      this.currentPosition = 0;
    } catch (error) {
      hilog.error(DOMAIN, 'AudioDetailPage', `Failed to stop playback: ${JSON.stringify(error)}`);
      this.showToast('Stop playback failed');
    }
  }

  /**
   * ä¸»æ’­æ”¾æŒ‰é’®ç‚¹å‡»å¤„ç† - ç±»ä¼¼å½•éŸ³é¡µé¢çš„åŠŸèƒ½
   */
  private async handleMainPlayButton(): Promise<void> {
    try {
      switch (this.playState) {
        case PlayState.IDLE:
          // å¼€å§‹æ’­æ”¾
          if (this.audioRecord?.filePath) {
            await this.audioPlayerService.play(this.audioRecord.filePath);
            this.startUpdateTimer();
          }
          break;
        case PlayState.PLAYING:
          // æš‚åœæ’­æ”¾
          await this.audioPlayerService.pause();
          this.stopUpdateTimer();
          break;
        case PlayState.PAUSED:
          // æ¢å¤æ’­æ”¾
          await this.audioPlayerService.resume();
          this.startUpdateTimer();
          break;
        case PlayState.STOPPED:
          // é‡æ–°å¼€å§‹æ’­æ”¾
          if (this.audioRecord?.filePath) {
            await this.audioPlayerService.play(this.audioRecord.filePath);
            this.startUpdateTimer();
          }
          break;
      }
    } catch (error) {
      hilog.error(DOMAIN, 'AudioDetailPage', `Failed to handle main play button: ${JSON.stringify(error)}`);
      this.showToast('Playback control failed');
    }
  }

  /**
   * è·å–æ’­æ”¾æŒ‰é’®é¢œè‰² - ç±»ä¼¼å½•éŸ³é¡µé¢çš„é¢œè‰²é€»è¾‘
   */
  private getPlayButtonColor(): string {
    switch (this.playState) {
      case PlayState.PLAYING:
        return '#FF3B30'; // æ’­æ”¾ä¸­ï¼šçº¢è‰²
      case PlayState.PAUSED:
        return '#FF9500'; // æš‚åœï¼šæ©™è‰²
      default:
        return '#007AFF'; // å…¶ä»–çŠ¶æ€ï¼šè“è‰²
    }
  }

  /**
   * è·³è½¬åˆ°æŒ‡å®šä½ç½®
   */
  private async seekTo(position: number): Promise<void> {
    try {
      await this.audioPlayerService.seekTo(position);
    } catch (error) {
      hilog.error(DOMAIN, 'AudioDetailPage', `Failed to seek: ${JSON.stringify(error)}`);
      this.showToast('Seek failed');
    }
  }

  /**
   * è®¾ç½®éŸ³é‡
   */
  private async setVolume(volume: number): Promise<void> {
    try {
      this.volume = volume;
      await this.audioPlayerService.setVolume(volume / 100);
    } catch (error) {
      hilog.error(DOMAIN, 'AudioDetailPage', `Failed to set volume: ${JSON.stringify(error)}`);
      this.showToast('Failed to set volume');
    }
  }

  /**
   * è®¾ç½®æ’­æ”¾é€Ÿåº¦
   */
  private async setPlaybackSpeed(speed: number): Promise<void> {
    try {
      this.playbackSpeed = speed;
      await this.audioPlayerService.setPlaybackSpeed(speed);
    } catch (error) {
      hilog.error(DOMAIN, 'AudioDetailPage', `Failed to set playback speed: ${JSON.stringify(error)}`);
      this.showToast('Failed to set playback speed');
    }
  }

  /**
   * æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
   */
  private showDeleteConfirmDialog(): void {
    const timestamp = new Date().toISOString();
    hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] ğŸ”” showDeleteConfirmDialog() called`);
    
    if (!this.audioRecord) {
      hilog.error(DOMAIN, 'AudioDetailPage', `[${timestamp}] âŒ Cannot show delete dialog: audioRecord is null`);
      this.showToast('éŸ³é¢‘è®°å½•ä¸å­˜åœ¨');
      return;
    }
    
    hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] ğŸ“ å‡†å¤‡åˆ é™¤çš„å½•éŸ³: '${this.audioRecord.fileName}'`);
    
    // ğŸ”¥ å…³é”®ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„å¯¹è¯æ¡†åˆ›å»ºæ–¹å¼ï¼ˆå‚ç…§GroupPageçš„å®ç°ï¼‰
    const dialogController: CustomDialogController = new CustomDialogController({
      builder: DeleteConfirmDialog({
        fileName: this.audioRecord?.fileName || '',
        onConfirm: () => {
          hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] âœ… ç”¨æˆ·ç¡®è®¤åˆ é™¤`);
          this.deleteAudioRecord();
        },
        onCancel: () => {
          hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] âŒ ç”¨æˆ·å–æ¶ˆåˆ é™¤`);
          this.closeDeleteDialog();
        }
      }),
      autoCancel: true,
      alignment: DialogAlignment.Center,
      offset: { dx: 0, dy: 0 } as DialogOffset
    });
    
    this.deleteDialogController = dialogController;
    
    try {
      dialogController.open();
      hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] âœ… åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†å·²æ˜¾ç¤º`);
    } catch (error) {
      hilog.error(DOMAIN, 'AudioDetailPage', `[${timestamp}] âŒ æ˜¾ç¤ºåˆ é™¤å¯¹è¯æ¡†å¤±è´¥: ${JSON.stringify(error)}`);
      this.showToast('æ˜¾ç¤ºå¯¹è¯æ¡†å¤±è´¥');
    }
  }

  /**
   * æ˜¾ç¤ºé‡å‘½åå¯¹è¯æ¡†
   */
  private showRenameDialog(): void {
    this.newFileName = this.audioRecord?.fileName || '';
    this.renameDialogController = new CustomDialogController({
      builder: RenameDialog({
        fileName: this.newFileName,
        onConfirm: (name: string) => this.renameAudioRecord(name),
        onCancel: () => this.closeRenameDialog()
      }),
      autoCancel: false,
      alignment: DialogAlignment.Center
    });
    this.renameDialogController.open();
  }

  /**
   * æ˜¾ç¤ºåˆ†ç»„é€‰æ‹©å¯¹è¯æ¡†
   */
  private showGroupSelectionDialog(): void {
    this.groupDialogController = new CustomDialogController({
      builder: GroupSelectionDialog({
        groups: this.availableGroups,
        selectedGroupId: this.selectedGroupId,
        onConfirm: (groupId: number) => this.moveToGroup(groupId),
        onCancel: () => this.closeGroupDialog()
      }),
      autoCancel: false,
      alignment: DialogAlignment.Center
    });
    this.groupDialogController.open();
  }

  /**
   * åˆ é™¤éŸ³é¢‘è®°å½•
   */
  private async deleteAudioRecord(): Promise<void> {
    const timestamp = new Date().toISOString();
    hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] ğŸ—‘ï¸ deleteAudioRecord() started`);
    
    try {
      if (!this.audioRecord) {
        hilog.error(DOMAIN, 'AudioDetailPage', `[${timestamp}] âŒ audioRecord is null`);
        this.showToast('éŸ³é¢‘è®°å½•ä¸å­˜åœ¨');
        return;
      }
      
      hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] ğŸ“Š å‡†å¤‡åˆ é™¤å½•éŸ³: ID=${this.audioRecord.id}, æ–‡ä»¶å='${this.audioRecord.fileName}'`);
      
      // åœæ­¢æ’­æ”¾
      hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] â¹ï¸ åœæ­¢æ’­æ”¾`);
      await this.stopPlayback();
      
      // åˆ é™¤æ–‡ä»¶
      hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] ğŸ“ åˆ é™¤æ–‡ä»¶: ${this.audioRecord.filePath}`);
      try {
        if (await fileIo.access(this.audioRecord.filePath)) {
          await fileIo.unlink(this.audioRecord.filePath);
          hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] âœ… æ–‡ä»¶åˆ é™¤æˆåŠŸ`);
        } else {
          hilog.warn(DOMAIN, 'AudioDetailPage', `[${timestamp}] âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤`);
        }
      } catch (fileError) {
        hilog.warn(DOMAIN, 'AudioDetailPage', `[${timestamp}] âš ï¸ æ–‡ä»¶åˆ é™¤å¤±è´¥: ${JSON.stringify(fileError)}`);
      }
      
      // ä»æ•°æ®åº“åˆ é™¤è®°å½•
      hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] ğŸ—„ï¸ ä»æ•°æ®åº“åˆ é™¤è®°å½•: ID=${this.audioRecord.id}`);
      await this.databaseService.deleteAudioRecord(this.audioRecord.id);
      hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] âœ… æ•°æ®åº“è®°å½•åˆ é™¤æˆåŠŸ`);
      
      // éªŒè¯åˆ é™¤æ˜¯å¦æˆåŠŸ
      const verifyRecord = await this.databaseService.getAudioRecordById(this.audioRecord.id);
      if (!verifyRecord) {
        hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] âœ… åˆ é™¤éªŒè¯æˆåŠŸï¼Œè®°å½•å·²ä¸å­˜åœ¨`);
      } else {
        hilog.error(DOMAIN, 'AudioDetailPage', `[${timestamp}] âŒ åˆ é™¤éªŒè¯å¤±è´¥ï¼Œè®°å½•ä»ç„¶å­˜åœ¨`);
      }
      
      this.showToast('åˆ é™¤æˆåŠŸ');
      this.closeDeleteDialog();
      
      // ç«‹å³è¿”å›ä¸Šä¸€é¡µ
      hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] ğŸ  å‡†å¤‡è¿”å›ä¸»é¡µé¢`);
      this.navigateBack();
      
    } catch (error) {
      hilog.error(DOMAIN, 'AudioDetailPage', `[${timestamp}] âŒ åˆ é™¤å¤±è´¥: ${JSON.stringify(error)}`);
      this.showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  /**
   * é‡å‘½åéŸ³é¢‘è®°å½•
   */
  private async renameAudioRecord(newName: string): Promise<void> {
    try {
      if (!this.audioRecord || !newName.trim()) {
        this.showToast('Please enter a valid filename');
        return;
      }
      
      const updatedRecord: AudioRecord = {
        id: this.audioRecord.id,
        fileName: newName.trim(),
        filePath: this.audioRecord.filePath,
        duration: this.audioRecord.duration,
        fileSize: this.audioRecord.fileSize,
        groupId: this.audioRecord.groupId,
        isTop: this.audioRecord.isTop,
        createTime: this.audioRecord.createTime
      } as AudioRecord;
      
      await this.databaseService.updateAudioRecord(updatedRecord);
      this.audioRecord = updatedRecord;
      
      this.showToast('Rename successful');
      this.closeRenameDialog();
      
    } catch (error) {
      hilog.error(DOMAIN, 'AudioDetailPage', `Failed to rename audio record: ${JSON.stringify(error)}`);
      this.showToast('Rename failed');
    }
  }

  /**
   * ç§»åŠ¨åˆ°åˆ†ç»„
   */
  private async moveToGroup(groupId: number): Promise<void> {
    try {
      if (!this.audioRecord) return;
      
      const updatedRecord: AudioRecord = {
        id: this.audioRecord.id,
        fileName: this.audioRecord.fileName,
        filePath: this.audioRecord.filePath,
        duration: this.audioRecord.duration,
        fileSize: this.audioRecord.fileSize,
        groupId: groupId === 0 ? undefined : groupId,
        isTop: this.audioRecord.isTop,
        createTime: this.audioRecord.createTime
      } as AudioRecord;
      
      await this.databaseService.updateAudioRecord(updatedRecord);
      this.audioRecord = updatedRecord;
      this.selectedGroupId = groupId;
      
      const groupName = groupId === 0 ? 'Ungrouped' : 
        this.availableGroups.find(g => g.id === groupId)?.groupName || 'Unknown Group';
      
      this.showToast(`Moved to ${groupName}`);
      this.closeGroupDialog();
      
    } catch (error) {
      hilog.error(DOMAIN, 'AudioDetailPage', `Failed to move to group: ${JSON.stringify(error)}`);
      this.showToast('Failed to move to group');
    }
  }

  /**
   * å…³é—­æ‰€æœ‰å¯¹è¯æ¡†
   */
  private closeAllDialogs(): void {
    this.closeDeleteDialog();
    this.closeRenameDialog();
    this.closeGroupDialog();
  }

  /**
   * å…³é—­åˆ é™¤å¯¹è¯æ¡†
   */
  private closeDeleteDialog(): void {
    const timestamp = new Date().toISOString();
    hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] ğŸ”’ closeDeleteDialog() called`);
    
    if (this.deleteDialogController) {
      try {
        this.deleteDialogController.close();
        this.deleteDialogController = null;
        hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] âœ… åˆ é™¤å¯¹è¯æ¡†å·²å…³é—­`);
      } catch (error) {
        hilog.error(DOMAIN, 'AudioDetailPage', `[${timestamp}] âŒ å…³é—­åˆ é™¤å¯¹è¯æ¡†å¤±è´¥: ${JSON.stringify(error)}`);
      }
    }
  }

  /**
   * å…³é—­é‡å‘½åå¯¹è¯æ¡†
   */
  private closeRenameDialog(): void {
    if (this.renameDialogController) {
      this.renameDialogController.close();
      this.renameDialogController = null;
    }
  }

  /**
   * å…³é—­åˆ†ç»„å¯¹è¯æ¡†
   */
  private closeGroupDialog(): void {
    if (this.groupDialogController) {
      this.groupDialogController.close();
      this.groupDialogController = null;
    }
  }

  /**
   * å¼€å§‹æ›´æ–°å®šæ—¶å™¨
   */
  private startUpdateTimer(): void {
    this.stopUpdateTimer();
    this.updateTimer = setInterval(() => {
      // å®šæ—¶å™¨ç”¨äºè§¦å‘UIæ›´æ–°ï¼Œå®é™…æ•°æ®é€šè¿‡å›è°ƒæ›´æ–°
    }, 100);
  }

  /**
   * åœæ­¢æ›´æ–°å®šæ—¶å™¨
   */
  private stopUpdateTimer(): void {
    if (this.updateTimer) {
      clearInterval(this.updateTimer);
      this.updateTimer = null;
    }
  }

  /**
   * æ ¼å¼åŒ–æ—¶é•¿
   */
  private formatDuration(duration: number): string {
    const totalSeconds = Math.floor(duration / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    
    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸ
   */
  private formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const hour = date.getHours().toString().padStart(2, '0');
    const minute = date.getMinutes().toString().padStart(2, '0');
    
    return `${year}-${month}-${day} ${hour}:${minute}`;
  }

  /**
   * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
   */
  private formatFileSize(size: number): string {
    if (size < 1024) {
      return `${size} B`;
    } else if (size < 1024 * 1024) {
      return `${(size / 1024).toFixed(1)} KB`;
    } else {
      return `${(size / (1024 * 1024)).toFixed(1)} MB`;
    }
  }

  /**
   * è·å–åˆ†ç»„åç§°
   */
  private getGroupName(): string {
    if (!this.audioRecord?.groupId) {
      return 'Ungrouped';
    }
    
    const group = this.availableGroups.find(g => g.id === this.audioRecord?.groupId);
    return group?.groupName || 'Unknown Group';
  }

  /**
   * æ˜¾ç¤ºæç¤ºä¿¡æ¯
   */
  private showToast(message: string): void {
    try {
      promptAction.showToast({
        message: message,
        duration: 2000
      });
    } catch (error) {
      // å¦‚æœUIä¸Šä¸‹æ–‡ä¸å¯ç”¨ï¼Œåªè®°å½•æ—¥å¿—ï¼Œä¸æŠ›å‡ºå¼‚å¸¸
      hilog.warn(DOMAIN, 'AudioDetailPage', `Failed to show toast (UI context not available): ${message}`);
    }
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  private navigateBack(): void {
    const timestamp = new Date().toISOString();
    hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] ğŸ  navigateBack() called`);
    
    // ä½¿ç”¨setTimeoutç¡®ä¿åœ¨å½“å‰UIäº‹ä»¶å¤„ç†å®Œæˆåå†æ‰§è¡Œå¯¼èˆª
    setTimeout(() => {
      try {
        router.back();
        hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] âœ… é¡µé¢è¿”å›æˆåŠŸ`);
      } catch (error) {
        hilog.error(DOMAIN, 'AudioDetailPage', `[${timestamp}] âŒ é¡µé¢è¿”å›å¤±è´¥: ${JSON.stringify(error)}`);
        // å°è¯•ä½¿ç”¨replaceUrlä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
        try {
          router.replaceUrl({ url: 'pages/Index' });
          hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] âœ… ä½¿ç”¨replaceUrlè¿”å›ä¸»é¡µé¢æˆåŠŸ`);
        } catch (replaceError) {
          hilog.error(DOMAIN, 'AudioDetailPage', `[${timestamp}] âŒ replaceUrlä¹Ÿå¤±è´¥: ${JSON.stringify(replaceError)}`);
        }
      }
    }, 100);
  }

  build() {
    Column() {
      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#007AFF')
          
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 12 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#F8F8F8')
      } else if (!this.audioRecord) {
        // é”™è¯¯çŠ¶æ€
        Column() {
          Image($r('app.media.icon'))
            .width(80)
            .height(80)
            .fillColor('#E5E5E5')
            .margin({ bottom: 16 })
          
          Text('éŸ³é¢‘è®°å½•ä¸å­˜åœ¨')
            .fontSize(16)
            .fontColor('#999999')
            .margin({ bottom: 20 })
          
          Button('è¿”å›')
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor('#007AFF')
            .borderRadius(8)
            .width(100)
            .height(40)
            .onClick(() => this.navigateBack())
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#F8F8F8')
      } else {
        // æ­£å¸¸å†…å®¹
        Column() {
          // é¡¶éƒ¨å¯¼èˆªæ 
          Row() {
            Button() {
              Image($r('app.media.back_button'))
                .width(120)
                .height(70)
                .fillColor('#333333')
            }
            .width(120)
            .height(70)
            .backgroundColor('transparent')
            .onClick(() => this.navigateBack())
            
            Text('éŸ³é¢‘è¯¦æƒ…')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .layoutWeight(1)
              .textAlign(TextAlign.Center)
          }
          .width('100%')
          .height(56)
          .padding({ left: 16, right: 16 })
          .backgroundColor('#FFFFFF')

          // éŸ³é¢‘ä¿¡æ¯å¡ç‰‡
          Column() {
            // ç§»é™¤éŸ³é¢‘å›¾æ ‡ï¼Œä¿æŒå¸ƒå±€é—´è·
            // Row()
            // .width(20)
            // .height(20)
            // .margin({ bottom: 0 })
            
            // æ–‡ä»¶å
            Text(this.audioRecord.fileName)
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .textAlign(TextAlign.Center)
              .margin({ bottom: 10 })
            
            // åˆ†ç»„ä¿¡æ¯
            Text(`åˆ†ç»„: ${this.getGroupName()}`)
              .fontSize(14)
              .fontColor('#666666')
              .margin({ bottom: 8 })
            
            // åˆ›å»ºæ—¶é—´
            Text(`åˆ›å»ºäº ${this.formatDate(this.audioRecord.createTime)}`)
              .fontSize(14)
              .fontColor('#999999')
              .margin({ bottom: 8 })
            
            // æ–‡ä»¶å¤§å°å’Œæ—¶é•¿
            Row() {
              Text(`å¤§å°: ${this.formatFileSize(this.audioRecord.fileSize)}`)
                .fontSize(14)
                .fontColor('#999999')
              
              Text('|')
                .fontSize(14)
                .fontColor('#E5E5E5')
                .margin({ left: 12, right: 12 })
              
              Text(`æ—¶é•¿: ${this.formatDuration(this.audioRecord.duration)}`)
                .fontSize(14)
                .fontColor('#999999')
            }
          }
          .width('100%')
          .padding(24)
          .backgroundColor('#FFFFFF')
          .margin({ top: 4, bottom: 4 })
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)

          // æ’­æ”¾æ§åˆ¶åŒºåŸŸ
          Column() {
            // è¿›åº¦æ¡
            Column() {
              Row() {
                Text(this.formatDuration(this.currentPosition))
                  .fontSize(12)
                  .fontColor('#666666')
                
                Blank()
                
                Text(this.formatDuration(this.totalDuration))
                  .fontSize(12)
                  .fontColor('#666666')
              }
              .width('100%')
              .margin({ bottom: 8 })
              
              Slider({
                value: this.totalDuration > 0 ? (this.currentPosition / this.totalDuration) * 100 : 0,
                min: 0,
                max: 100,
                step: 1
              })
                .width('100%')
                .trackColor('#E5E5E5')
                .selectedColor('#007AFF')
                .blockColor('#007AFF')
                .onChange((value: number) => {
                  const position = (value / 100) * this.totalDuration;
                  this.seekTo(position);
                })
            }
            .width('100%')
            .margin({ bottom: 8 })
            
            // æ’­æ”¾æ§åˆ¶æŒ‰é’®
            Row() {
              // æ’­æ”¾é€Ÿåº¦
              Button(`${this.playbackSpeed}x`)
                .fontSize(14)
                .fontColor('#007AFF')
                .backgroundColor('#F0F8FF')
                .borderRadius(20)
                .width(60)
                .height(40)
                .onClick(() => {
                  const speeds = [0.5, 0.75, 1.0, 1.25, 1.5, 2.0];
                  const currentIndex = speeds.indexOf(this.playbackSpeed);
                  const nextIndex = (currentIndex + 1) % speeds.length;
                  this.setPlaybackSpeed(speeds[nextIndex]);
                })
              
              Blank()
              
              // ä¸»æ’­æ”¾æ§åˆ¶æŒ‰é’®
              Button() {
                Column() {
                  if (this.playState === PlayState.PLAYING) {
                    // æ’­æ”¾ä¸­æ˜¾ç¤ºæš‚åœå›¾æ ‡
                    Row()
                      .width(20)
                      .height(20)
                      .backgroundColor('#FFFFFF')
                      .borderRadius(2)
                  } else if (this.playState === PlayState.PAUSED) {
                    // æš‚åœçŠ¶æ€æ˜¾ç¤ºæ’­æ”¾å›¾æ ‡
                    Circle()
                      .width(24)
                      .height(24)
                      .fill('#FFFFFF')
                  } else {
                    // åœæ­¢/ç©ºé—²çŠ¶æ€æ˜¾ç¤ºæ’­æ”¾å›¾æ ‡
                    Circle()
                      .width(24)
                      .height(24)
                      .fill('#FFFFFF')
                  }
                }
              }
              .width(70)
              .height(70)
              .backgroundColor(this.getPlayButtonColor())
              .borderRadius(40)
              .onClick(() => this.handleMainPlayButton())
              
              Blank()
            }
            .width('100%')
            .alignItems(VerticalAlign.Center)
            
            // éŸ³é‡æ§åˆ¶
            Row() {
              Image($r('app.media.Audio'))
                .width(50)
                .height(50)
                .fillColor('#666666')
                .margin({ right: 12 })
              
              Slider({
                value: this.volume,
                min: 0,
                max: 100,
                step: 1
              })
                .layoutWeight(1)
                .trackColor('#E5E5E5')
                .selectedColor('#007AFF')
                .blockColor('#007AFF')
                .onChange((value: number) => {
                  this.setVolume(value);
                })
              
              Text(`${Math.round(this.volume)}%`)
                .fontSize(16)
                .fontColor('#666666')
                .width(40)
                .textAlign(TextAlign.End)
                .margin({ left: 12 })
            }
            .width('100%')
            .margin({ top: 20 })
          }
          .width('100%')
          .padding(21)
          .backgroundColor('#FFFFFF')
          .margin({ bottom: 8 })

          // æ“ä½œæŒ‰é’®åŒºåŸŸ
          Column() {
            Row() {
              Button('é‡å‘½å')
                .fontSize(16)
                .fontColor('#007AFF')
                .backgroundColor('#F0F8FF')
                .borderRadius(8)
                .layoutWeight(1)
                .height(44)
                .onClick(() => this.showRenameDialog())
              
              Button('ç§»åŠ¨åˆ†ç»„')
                .fontSize(16)
                .fontColor('#FF9500')
                .backgroundColor('#FFF8F0')
                .borderRadius(8)
                .layoutWeight(1)
                .height(44)
                .margin({ left: 12 })
                .onClick(() => this.showGroupSelectionDialog())
            }
            .width('100%')
            .margin({ bottom: 8 })
            
            Button('åˆ é™¤éŸ³é¢‘')
              .fontSize(16)
              .fontColor('#FF3B30')
              .backgroundColor('#FFF0F0')
              .borderRadius(8)
              .width('100%')
              .height(44)
              .onClick(() => {
                const timestamp = new Date().toISOString();
                hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] ğŸ”˜ åˆ é™¤éŸ³é¢‘æŒ‰é’®è¢«ç‚¹å‡»`);
                this.showDeleteConfirmDialog();
              })
          }
          .width('100%')
          .padding(24)
          .backgroundColor('#FFFFFF')
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#F8F8F8')
      }
    }
    .width('100%')
    .height('100%')
  }
}

// åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
@CustomDialog
struct DeleteConfirmDialog {
  fileName: string = '';
  controller: CustomDialogController = new CustomDialogController({builder: () => {}});
  onConfirm?: () => void;
  onCancel?: () => void;

  build() {
    Column() {
      Column() {
        // æ ‡é¢˜
        Text('åˆ é™¤éŸ³é¢‘')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .width('100%')
          .textAlign(TextAlign.Center)
          .margin({ bottom: 20 })
        
        // æç¤ºæ–‡æœ¬
        Column() {
          Text(`ç¡®å®šè¦åˆ é™¤"${this.fileName}"å—ï¼Ÿ`)
            .fontSize(16)
            .fontColor('#666666')
            .textAlign(TextAlign.Center)
            .width('100%')
            .margin({ bottom: 8 })
          
          Text('åˆ é™¤åæ— æ³•æ¢å¤')
            .fontSize(14)
            .fontColor('#FF3B30')
            .textAlign(TextAlign.Center)
            .width('100%')
        }
        .width('100%')
        .margin({ bottom: 30 })
        
        // æŒ‰é’®åŒºåŸŸ
        Row() {
          Button() {
            Text('å–æ¶ˆ')
              .fontSize(16)
              .fontColor('#666666')
          }
          .fontSize(16)
          .fontColor('#666666')
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .width(100)
          .height(44)
          .onClick(() => {
            const timestamp = new Date().toISOString();
            hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] ğŸ”˜ å¯¹è¯æ¡†å–æ¶ˆæŒ‰é’®è¢«ç‚¹å‡»`);
            if (this.onCancel) {
              this.onCancel();
            }
          })
          
          Blank()
          
          Button() {
            Text('åˆ é™¤')
              .fontSize(16)
              .fontColor('#FFFFFF')
          }
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor('#FF3B30')
          .borderRadius(8)
          .width(100)
          .height(44)
          .onClick(() => {
            const timestamp = new Date().toISOString();
            hilog.info(DOMAIN, 'AudioDetailPage', `[${timestamp}] ğŸ”˜ å¯¹è¯æ¡†åˆ é™¤æŒ‰é’®è¢«ç‚¹å‡»`);
            if (this.onConfirm) {
              this.onConfirm();
            }
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .width('100%')
      .padding(24)
      .backgroundColor('#FFFFFF')
      .borderRadius(16)
      .shadow({ radius: 16, color: '#00000030' })
    }
    .width(320)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }
}

// é‡å‘½åå¯¹è¯æ¡†
@CustomDialog
struct RenameDialog {
  @State fileName: string = '';
  controller: CustomDialogController = new CustomDialogController({builder: () => {}});
  onConfirm?: (name: string) => void;
  onCancel?: () => void;

  build() {
    Column() {
      Text('é‡å‘½åéŸ³é¢‘')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .margin({ bottom: 20 })
      
      TextInput({ placeholder: 'è¯·è¾“å…¥æ–°çš„æ–‡ä»¶å', text: this.fileName })
        .width('100%')
        .height(44)
        .backgroundColor('#F8F8F8')
        .borderRadius(8)
        .padding({ left: 12, right: 12 })
        .margin({ bottom: 20 })
        .onChange((value: string) => {
          this.fileName = value;
        })
      
      Row() {
        Button('å–æ¶ˆ')
          .fontSize(16)
          .fontColor('#666666')
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .width(100)
          .height(40)
          .onClick(() => {
            if (this.onCancel) {
              this.onCancel();
            }
          })
        
        Blank()
        
        Button('ä¿å­˜')
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor('#007AFF')
          .borderRadius(8)
          .width(100)
          .height(40)
          .onClick(() => {
            if (this.onConfirm) {
              this.onConfirm(this.fileName);
            }
          })
      }
      .width('100%')
    }
    .width(300)
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
  }
}

// åˆ†ç»„é€‰æ‹©å¯¹è¯æ¡†
@CustomDialog
struct GroupSelectionDialog {
  @State selectedGroupId: number = 0;
  groups: AudioGroup[] = [];
  controller: CustomDialogController = new CustomDialogController({builder: () => {}});
  onConfirm?: (groupId: number) => void;
  onCancel?: () => void;

  build() {
    Column() {
      Text('é€‰æ‹©åˆ†ç»„')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .margin({ bottom: 20 })
      
      // åˆ†ç»„åˆ—è¡¨
      Column() {
        // æœªåˆ†ç»„é€‰é¡¹
        Row() {
          Radio({ value: '0', group: 'group' })
            .checked(this.selectedGroupId === 0)
            .onChange((isChecked: boolean) => {
              if (isChecked) {
                this.selectedGroupId = 0;
              }
            })
          
          Text('æœªåˆ†ç»„')
            .fontSize(16)
            .fontColor('#333333')
            .margin({ left: 12 })
            .layoutWeight(1)
        }
        .width('100%')
        .height(44)
        .alignItems(VerticalAlign.Center)
        .onClick(() => {
          this.selectedGroupId = 0;
        })
        
        // åˆ†ç»„é€‰é¡¹
        ForEach(this.groups, (group: AudioGroup) => {
          Row() {
            Radio({ value: group.id.toString(), group: 'group' })
              .checked(this.selectedGroupId === group.id)
              .onChange((isChecked: boolean) => {
                if (isChecked) {
                  this.selectedGroupId = group.id;
                }
              })
            
            Text(group.groupName)
              .fontSize(16)
              .fontColor('#333333')
              .margin({ left: 12 })
              .layoutWeight(1)
          }
          .width('100%')
          .height(44)
          .alignItems(VerticalAlign.Center)
          .onClick(() => {
            this.selectedGroupId = group.id;
          })
        })
      }
      .width('100%')
      .height(200)
      .margin({ bottom: 20 })
      
      Row() {
        Button('å–æ¶ˆ')
          .fontSize(16)
          .fontColor('#666666')
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .width(100)
          .height(40)
          .onClick(() => {
            if (this.onCancel) {
              this.onCancel();
            }
          })
        
        Blank()
        
        Button('ç¡®å®š')
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor('#007AFF')
          .borderRadius(8)
          .width(100)
          .height(40)
          .onClick(() => {
            if (this.onConfirm) {
              this.onConfirm(this.selectedGroupId);
            }
          })
      }
      .width('100%')
    }
    .width(320)
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
  }
}