import hilog from '@ohos.hilog';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { authentication } from '@kit.AccountKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { common } from '@kit.AbilityKit';
import { DatabaseService } from '../service/DatabaseService';
import { AudioRecord, AudioGroup, TabType, MultiSelectState, DynamicTab } from '../model/DataModel';

const DOMAIN = 0xFF00;





@Entry
@Component
struct Index {
  @State private audioRecords: AudioRecord[] = [];
  @State private favoriteRecords: AudioRecord[] = [];
  @State private groupRecords: AudioRecord[] = [];
  @State private audioGroups: AudioGroup[] = [];
  @State private searchResults: AudioRecord[] = [];
  @State private currentTab: TabType = TabType.ALL;
  @State private currentGroupId: number = 0;
  @State private searchKeyword: string = '';
  @State private isSearchMode: boolean = false;
  @State private isLoading: boolean = false;
  @State private dynamicTabs: DynamicTab[] = [];
  @State private multiSelectState: MultiSelectState = {
    isMultiSelectMode: false,
    selectedRecords: new Set<number>()
  };
  @State private showGroupSelectionDialog: boolean = false;
  @State private showCreateGroupDialog: boolean = false;
  @State private showRenameGroupDialog: boolean = false;
  @State private showTabContextMenu: boolean = false;
  @State private newGroupName: string = '';
  @State private renameGroupName: string = '';
  @State private selectedTabForAction: DynamicTab | null = null;
  private longPressTimer: number = -1;
  private longPressTab: DynamicTab | null = null;

  private databaseService: DatabaseService = DatabaseService.getInstance();
  private context = getContext(this) as common.UIAbilityContext;

  aboutToAppear(): void {
    this.initializeData();
  }

  onPageShow(): void {
    // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶éƒ½é‡æ–°åŠ è½½æ•°æ®ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°çš„å½•éŸ³è®°å½•
    const timestamp = new Date().toISOString();
    hilog.info(DOMAIN, 'Index', `[${timestamp}] onPageShow: é¡µé¢æ˜¾ç¤ºï¼Œå½“å‰isLoadingçŠ¶æ€: ${this.isLoading}`);
    
    if (this.isLoading) {
      hilog.info(DOMAIN, 'Index', `[${timestamp}] å½“å‰æ­£åœ¨åŠ è½½ä¸­ï¼Œå»¶è¿Ÿ500msåé‡æ–°åŠ è½½æ•°æ®`);
      setTimeout(() => {
        const retryTimestamp = new Date().toISOString();
        hilog.info(DOMAIN, 'Index', `[${retryTimestamp}] å»¶è¿Ÿé‡æ–°åŠ è½½æ•°æ®`);
        this.reloadAllData();
      }, 500);
    } else {
      hilog.info(DOMAIN, 'Index', `[${timestamp}] ç«‹å³é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®`);
      this.reloadAllData();
    }
  }

  /**
   * é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
   */
  private async reloadAllData(): Promise<void> {
    const timestamp = new Date().toISOString();
    try {
      hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ”„ å¼€å§‹é‡æ–°åŠ è½½éŸ³é¢‘è®°å½•`);
      await this.loadAudioRecords();
      hilog.info(DOMAIN, 'Index', `[${timestamp}] âœ… éŸ³é¢‘è®°å½•åŠ è½½å®Œæˆï¼Œå½“å‰è®°å½•æ•°: ${this.audioRecords.length}`);
      
      hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ”„ å¼€å§‹é‡æ–°åŠ è½½éŸ³é¢‘åˆ†ç»„`);
      await this.loadAudioGroups();
      hilog.info(DOMAIN, 'Index', `[${timestamp}] âœ… éŸ³é¢‘åˆ†ç»„åŠ è½½å®Œæˆï¼Œå½“å‰åˆ†ç»„æ•°: ${this.audioGroups.length}`);
      
      hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ”„ å¼€å§‹é‡æ–°åˆå§‹åŒ–åŠ¨æ€æ ‡ç­¾`);
      this.initializeDynamicTabs();
      hilog.info(DOMAIN, 'Index', `[${timestamp}] âœ… åŠ¨æ€æ ‡ç­¾åˆå§‹åŒ–å®Œæˆï¼Œå½“å‰æ ‡ç­¾æ•°: ${this.dynamicTabs.length}`);
      
      hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ‰ æ‰€æœ‰æ•°æ®é‡æ–°åŠ è½½å®Œæˆï¼`);
      hilog.info(DOMAIN, 'Index', `[${timestamp}] å½“å‰æ˜¾ç¤ºçš„éŸ³é¢‘åˆ—è¡¨é•¿åº¦: ${this.getCurrentAudioList().length}`);
    } catch (error) {
      hilog.error(DOMAIN, 'Index', `[${timestamp}] âŒ é‡æ–°åŠ è½½æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯: ${JSON.stringify(error)}`);
    }
  }

  private async initializeData(): Promise<void> {
    try {
      this.isLoading = true;
      await this.databaseService.initDatabase(this.context);
      
      // å…³é”®ä¿®å¤ï¼šå¯åŠ¨æ—¶è‡ªåŠ¨æ¸…ç†æ¨¡æ‹Ÿæ•°æ®
      hilog.info(DOMAIN, 'Index', 'Cleaning up mock data on startup...');
      await this.databaseService.cleanupMockData();
      
      // åŠ è½½éŸ³é¢‘è®°å½•å’Œåˆ†ç»„
      await this.loadAudioRecords();
      await this.loadAudioGroups();
      
      // åˆå§‹åŒ–åŠ¨æ€æ ‡ç­¾
      this.initializeDynamicTabs();
    } catch (error) {
      hilog.error(DOMAIN, 'Index', `Failed to initialize data: ${JSON.stringify(error)}`);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * åŠ è½½éŸ³é¢‘è®°å½•
   */
  private async loadAudioRecords(): Promise<void> {
    const timestamp = new Date().toISOString();
    try {
      hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ”„ å¼€å§‹åŠ è½½éŸ³é¢‘è®°å½•`);
      this.isLoading = true;
      
      hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ“ è°ƒç”¨æ•°æ®åº“æŸ¥è¯¢æ–¹æ³•`);
      hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ” æ•°æ®åº“å®ä¾‹æ£€æŸ¥: ${this.databaseService ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}`);
      const records = await this.databaseService.queryAllAudioRecords();
      
      hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ“Š ä»æ•°æ®åº“è·å–åˆ° ${records.length} æ¡éŸ³é¢‘è®°å½•`);
      
      if (records.length > 0) {
        hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ“ æœ€æ–°çš„3æ¡è®°å½•è¯¦æƒ…:`);
        records.slice(0, 3).forEach((record, index) => {
          hilog.info(DOMAIN, 'Index', `[${timestamp}]   è®°å½•${index + 1}: ID=${record.id}, æ–‡ä»¶å='${record.fileName}', åˆ›å»ºæ—¶é—´=${new Date(record.createTime).toLocaleString()}`);
        });
      } else {
        hilog.warn(DOMAIN, 'Index', `[${timestamp}] âš ï¸ æ²¡æœ‰è·å–åˆ°ä»»ä½•éŸ³é¢‘è®°å½•`);
      }
      
      this.audioRecords = records;
      hilog.info(DOMAIN, 'Index', `[${timestamp}] âœ… éŸ³é¢‘è®°å½•å·²æ›´æ–°åˆ°é¡µé¢çŠ¶æ€ï¼Œå½“å‰audioRecordsé•¿åº¦: ${this.audioRecords.length}`);
      
      // ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶è§¦å‘UIæ›´æ–°
      setTimeout(() => {
        const uiUpdateTimestamp = new Date().toISOString();
        hilog.info(DOMAIN, 'Index', `[${uiUpdateTimestamp}] ğŸ”„ å¼ºåˆ¶è§¦å‘UIæ›´æ–°ï¼Œå½“å‰audioRecordsé•¿åº¦: ${this.audioRecords.length}`);
        // é€šè¿‡é‡æ–°èµ‹å€¼è§¦å‘çŠ¶æ€æ›´æ–°
        this.audioRecords = [...this.audioRecords];
      }, 100);
      
      // æš‚æ—¶ç§»é™¤æ”¶è—åŠŸèƒ½ï¼Œåç»­ä¼šåˆ é™¤æ”¶è—tab
      this.favoriteRecords = [];
      if (this.currentTab === TabType.GROUP && this.currentGroupId) {
        // ğŸ”¥ å¤šåˆ†ç»„æ”¯æŒï¼šä»æ‰€æœ‰è®°å½•ä¸­ç­›é€‰å‡ºæŒ‡å®šåˆ†ç»„çš„è®°å½•
        this.groupRecords = records.filter(record => {
          if (record.groupIds) {
            return record.groupIds.includes(this.currentGroupId);
          }
          // å…¼å®¹æ—§ç‰ˆæœ¬
          return record.groupId === this.currentGroupId;
        });
      }
      
    } catch (error) {
      hilog.error(DOMAIN, 'Index', `[${timestamp}] âŒ åŠ è½½éŸ³é¢‘è®°å½•å¤±è´¥: ${JSON.stringify(error)}`);
    } finally {
      this.isLoading = false;
      hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ éŸ³é¢‘è®°å½•åŠ è½½å®Œæˆï¼ŒisLoadingè®¾ä¸ºfalse`);
    }
  }

  private async loadAudioGroups(): Promise<void> {
    try {
      this.audioGroups = await this.databaseService.getAllGroups();
    } catch (error) {
      hilog.error(DOMAIN, 'Index', `Failed to load audio groups: ${JSON.stringify(error)}`);
    }
  }

  private async searchAudio(keyword: string): Promise<void> {
    if (keyword.trim() === '') {
      this.isSearchMode = false;
      this.searchResults = [];
      return;
    }

    this.isSearchMode = true;
    try {
      this.searchResults = await this.databaseService.searchAudioRecords(keyword);
    } catch (error) {
      hilog.error(DOMAIN, 'Index', `Failed to search audio: ${JSON.stringify(error)}`);
    }
  }

  private onTabChange(tabType: TabType, groupId?: number): void {
    this.currentTab = tabType;
    this.currentGroupId = groupId || 0;
    this.exitMultiSelectMode();
    
    if (tabType === TabType.GROUP && groupId) {
      this.loadAudioRecords();
    }
  }

  private enterMultiSelectMode(initialRecordId?: number): void {
    this.multiSelectState = {
      isMultiSelectMode: true,
      selectedRecords: new Set<number>(initialRecordId ? [initialRecordId] : [])
    };
  }

  private exitMultiSelectMode(): void {
    this.multiSelectState = {
      isMultiSelectMode: false,
      selectedRecords: new Set<number>()
    };
  }

  private initializeDynamicTabs(): void {
    const timestamp = new Date().toISOString();
    
    // ğŸ”¥ å…³é”®ä¿®å¤ï¼šä¸ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ï¼Œæ”¹ç”¨æ•°ç»„æ‹¼æ¥
    const tabs: DynamicTab[] = [];
    
    // æ·»åŠ "å…¨éƒ¨"æ ‡ç­¾
    tabs.push({ id: 0, type: TabType.ALL, name: 'å…¨éƒ¨' });
    
    // æ·»åŠ åˆ†ç»„æ ‡ç­¾
    this.audioGroups.forEach((group, index) => {
      tabs.push({
        id: index + 1,
        type: TabType.GROUP,
        name: group.groupName,
        groupId: group.id
      });
    });
    
    this.dynamicTabs = tabs;
    
    hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ·ï¸ åŠ¨æ€æ ‡ç­¾åˆå§‹åŒ–å®Œæˆï¼Œå…±${tabs.length}ä¸ªæ ‡ç­¾:`);
    this.dynamicTabs.forEach((tab, idx) => {
      hilog.info(DOMAIN, 'Index', `[${timestamp}]   Tab${idx}: name="${tab.name}", type=${tab.type} (${typeof tab.type}), groupId=${tab.groupId}`);
    });
    hilog.info(DOMAIN, 'Index', `[${timestamp}]   TabType.ALL=${TabType.ALL}, TabType.GROUP=${TabType.GROUP}`);
  }

  private showGroupSelectionDialogMethod(): void {
    this.showGroupSelectionDialog = true;
  }

  private async createNewGroup(): Promise<void> {
    if (this.newGroupName.trim() === '') return;

    try {
      await this.databaseService.createGroup(this.newGroupName.trim());
      await this.loadAudioGroups();
      this.initializeDynamicTabs();
      this.showCreateGroupDialog = false;
      this.newGroupName = '';
    } catch (error) {
      hilog.error(DOMAIN, 'Index', `Failed to create group: ${JSON.stringify(error)}`);
    }
  }

  private async addToGroup(groupId: number): Promise<void> {
    const selectedIds = Array.from(this.multiSelectState.selectedRecords);
    if (selectedIds.length === 0) return;

    try {
      // æ‰¹é‡æ·»åŠ éŸ³é¢‘åˆ°åˆ†ç»„
      for (const audioId of selectedIds) {
        await this.databaseService.addAudioToGroup(audioId, groupId);
      }
      await this.loadAudioRecords();
      this.exitMultiSelectMode();
      this.showGroupSelectionDialog = false;
    } catch (error) {
      hilog.error(DOMAIN, 'Index', `Failed to add to group: ${JSON.stringify(error)}`);
    }
  }

  private selectExistingGroup(groupId: number): void {
    this.addToGroup(groupId);
  }

  private showRenameGroupDialogMethod(): void {
    if (this.selectedTabForAction && this.selectedTabForAction.type === TabType.GROUP) {
      this.renameGroupName = this.selectedTabForAction.name;
      this.showRenameGroupDialog = true;
      this.showTabContextMenu = false;
    }
  }

  private async renameGroup(): Promise<void> {
    if (!this.selectedTabForAction || !this.selectedTabForAction.groupId || this.renameGroupName.trim() === '') {
      return;
    }

    try {
      await this.databaseService.updateGroupName(this.selectedTabForAction.groupId, this.renameGroupName.trim());
      await this.loadAudioGroups();
      this.initializeDynamicTabs();
      this.showRenameGroupDialog = false;
      this.renameGroupName = '';
      this.selectedTabForAction = null;
    } catch (error) {
      hilog.error(DOMAIN, 'Index', `Failed to rename group: ${JSON.stringify(error)}`);
    }
  }

  private async deleteGroup(): Promise<void> {
    if (!this.selectedTabForAction || !this.selectedTabForAction.groupId) return;

    try {
      await this.databaseService.deleteGroup(this.selectedTabForAction.groupId);
      await this.loadAudioGroups();
      this.initializeDynamicTabs();
      
      if (this.currentTab === TabType.GROUP && this.currentGroupId === this.selectedTabForAction.groupId) {
        this.onTabChange(TabType.ALL);
      }
      
      this.showTabContextMenu = false;
      this.selectedTabForAction = null;
    } catch (error) {
      hilog.error(DOMAIN, 'Index', `Failed to delete group: ${JSON.stringify(error)}`);
    }
  }

  private getCurrentAudioList(): AudioRecord[] {
    const timestamp = new Date().toISOString();
    hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ¯ getCurrentAudioList() è¢«è°ƒç”¨`);
    hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ“Š å½“å‰çŠ¶æ€: isSearchMode=${this.isSearchMode}, currentTab=${this.currentTab}`);
    
    let resultList: AudioRecord[] = [];
    
    if (this.isSearchMode) {
      resultList = this.searchResults;
      hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ” æœç´¢æ¨¡å¼ - è¿”å›æœç´¢ç»“æœ: ${resultList.length} æ¡è®°å½•`);
    } else {
      switch (this.currentTab) {
        case TabType.ALL:
          resultList = this.audioRecords;
          hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ“‹ å…¨éƒ¨æ ‡ç­¾ - è¿”å›æ‰€æœ‰è®°å½•: ${resultList.length} æ¡è®°å½•`);
          break;
        case TabType.GROUP:
          resultList = this.groupRecords;
          hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ‘¥ åˆ†ç»„æ ‡ç­¾ - è¿”å›åˆ†ç»„è®°å½•: ${resultList.length} æ¡è®°å½• (åˆ†ç»„ID: ${this.currentGroupId})`);
          break;
        default:
          resultList = this.audioRecords;
          hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ”„ é»˜è®¤æƒ…å†µ - è¿”å›æ‰€æœ‰è®°å½•: ${resultList.length} æ¡è®°å½•`);
          break;
      }
    }
    
    if (resultList.length > 0) {
      hilog.info(DOMAIN, 'Index', `[${timestamp}] ğŸ“ è¿”å›åˆ—è¡¨çš„å‰3æ¡è®°å½•:`);
      resultList.slice(0, 3).forEach((record, index) => {
        hilog.info(DOMAIN, 'Index', `[${timestamp}]   è®°å½•${index + 1}: ID=${record.id}, æ–‡ä»¶å='${record.fileName}', åˆ›å»ºæ—¶é—´=${new Date(record.createTime).toLocaleString()}`);
      });
    } else {
      hilog.warn(DOMAIN, 'Index', `[${timestamp}] âš ï¸ è¿”å›çš„åˆ—è¡¨ä¸ºç©º`);
    }
    
    return resultList;
  }

  private navigateToRecord(): void {
    router.pushUrl({ url: 'pages/RecordPage' });
  }

  private navigateToGroup(): void {
    router.pushUrl({ url: 'pages/GroupPage' });
  }

  private navigateToAudioDetail(audioRecord: AudioRecord): void {
    router.pushUrl({
      url: 'pages/AudioDetailPage',
      params: { audioId: audioRecord.id }
    });
  }

  private toggleRecordSelection(recordId: number): void {
    const newSelectedRecords = new Set(this.multiSelectState.selectedRecords);
    if (newSelectedRecords.has(recordId)) {
      newSelectedRecords.delete(recordId);
    } else {
      newSelectedRecords.add(recordId);
    }
    
    this.multiSelectState = {
      isMultiSelectMode: this.multiSelectState.isMultiSelectMode,
      selectedRecords: newSelectedRecords
    };
  }

  private async toggleTopStatus(audioRecord: AudioRecord): Promise<void> {
    try {
      await this.databaseService.toggleTopStatus(audioRecord.id, !audioRecord.isTop);
      await this.loadAudioRecords();
    } catch (error) {
      hilog.error(DOMAIN, 'Index', `Failed to toggle top status: ${JSON.stringify(error)}`);
    }
  }

  private formatDuration(duration: number): string {
    const seconds = Math.floor(duration / 1000);
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
  }

  private formatFileSize(size: number): string {
    if (size < 1024) {
      return `${size}B`;
    } else if (size < 1024 * 1024) {
      return `${(size / 1024).toFixed(1)}KB`;
    } else {
      return `${(size / (1024 * 1024)).toFixed(1)}MB`;
    }
  }

  private formatCreateTime(timestamp: number): string {
    const date = new Date(timestamp);
    const now = new Date();
    const diffTime = now.getTime() - date.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays === 0) {
      return `ä»Šå¤© ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    } else if (diffDays === 1) {
      return `æ˜¨å¤© ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    } else if (diffDays < 7) {
      return `${diffDays}å¤©å‰`;
    } else {
      return `${date.getMonth() + 1}/${date.getDate()}`;
    }
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨æ ‡é¢˜æ 
        Row() {
          Text('éŸ³é¢‘æ—¥è®°')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .backgroundColor('#FFFFFF')

        // æœç´¢æ¡†
        Row() {
          TextInput({ placeholder: 'æœç´¢éŸ³é¢‘æ–‡ä»¶', text: this.searchKeyword })
            .backgroundColor('transparent')
            .border({ width: 0 })
            .layoutWeight(1)
            .onChange((value: string) => {
              this.searchKeyword = value;
              this.searchAudio(value);
            })
        }
        .width('100%')
        .height(40)
        .padding({ left: 12, right: 12 })
        .margin({ left: 16, right: 16, top: 8, bottom: 8 })
        .backgroundColor('#F8F8F8')
        .borderRadius(20)

        // Tabå¯¼èˆª
        if (!this.isSearchMode) {
          Row() {
            ForEach(this.dynamicTabs, (tab: DynamicTab, index?: number) => {
              // ğŸ”¥ å…³é”®ä¿®å¤ï¼šåŒæ—¶ä½¿ç”¨æ‰‹åŠ¿å’Œè§¦æ‘¸äº‹ä»¶ï¼Œç¡®ä¿é•¿æŒ‰èƒ½è¢«æ•è·
              Column() {
                Text(tab.name)
                  .fontSize(14)
                  .fontColor((this.currentTab === tab.type && this.currentGroupId === tab.groupId) ? '#007AFF' : '#666666')
                  .padding({ left: 12, right: 12, top: 8, bottom: 8 })
              }
              .margin({ left: (index !== undefined && index > 0) ? 24 : 0 })
              .onClick(() => {
                // æ¸…é™¤é•¿æŒ‰å®šæ—¶å™¨
                if (this.longPressTimer !== -1) {
                  clearTimeout(this.longPressTimer);
                  this.longPressTimer = -1;
                }
                
                hilog.info(DOMAIN, 'Index', `ç‚¹å‡»Tab: ${tab.name}, type=${tab.type}`);
                this.onTabChange(tab.type, tab.groupId);
              })
              .onTouch((event) => {
                if (tab.type !== TabType.GROUP) {
                  return;
                }
                
                if (event.type === TouchType.Down) {
                  // å¼€å§‹é•¿æŒ‰è®¡æ—¶
                  hilog.info(DOMAIN, 'Index', `ğŸ‘‡ TouchDown on ${tab.name}`);
                  this.longPressTab = tab;
                  this.longPressTimer = setTimeout(() => {
                    hilog.info(DOMAIN, 'Index', `â° é•¿æŒ‰è§¦å‘: ${tab.name}`);
                    this.selectedTabForAction = tab;
                    this.showTabContextMenu = true;
                    this.longPressTimer = -1;
                  }, 500); // 500msé•¿æŒ‰æ—¶é—´
                } else if (event.type === TouchType.Up || event.type === TouchType.Cancel) {
                  // å–æ¶ˆé•¿æŒ‰è®¡æ—¶
                  hilog.info(DOMAIN, 'Index', `ğŸ‘† TouchUp/Cancel on ${tab.name}`);
                  if (this.longPressTimer !== -1) {
                    clearTimeout(this.longPressTimer);
                    this.longPressTimer = -1;
                  }
                }
              })
            })
            
            Blank()
          }
          .width('100%')
          .height(44)
          .padding({ left: 16, right: 16 })
          .backgroundColor('#FFFFFF')
        }

        // éŸ³é¢‘åˆ—è¡¨
        if (this.isLoading) {
          Column() {
            LoadingProgress()
              .width(40)
              .height(40)
              .color('#007AFF')
            
            Text('åŠ è½½ä¸­...')
              .fontSize(14)
              .fontColor('#999999')
              .margin({ top: 8 })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        } else {
          List() {
            ForEach(this.getCurrentAudioList(), (audioRecord: AudioRecord) => {
              ListItem() {
                this.AudioRecordItemBuilder(audioRecord)
              }
              .swipeAction({ end: this.SwipeActionsBuilder(audioRecord) })
            })
          }
          .width('100%')
          .layoutWeight(1)
          .backgroundColor('#F8F8F8')
          .divider({
            strokeWidth: 0.5,
            color: '#E5E5E5',
            startMargin: 16,
            endMargin: 16
          })
        }

        // å¤šé€‰æ¨¡å¼æ“ä½œæ 
        if (this.multiSelectState.isMultiSelectMode) {
          Row() {
            Button('å–æ¶ˆ')
              .fontSize(14)
              .fontColor('#666666')
              .backgroundColor('transparent')
              .border({ width: 1, color: '#E5E5E5' })
              .borderRadius(8)
              .padding({ left: 16, right: 16, top: 8, bottom: 8 })
              .onClick(() => this.exitMultiSelectMode())
            
            Blank()
            
            Text(`å·²é€‰æ‹© ${this.multiSelectState.selectedRecords.size} é¡¹`)
              .fontSize(14)
              .fontColor('#666666')
            
            Blank()
            
            Button('æ·»åŠ åˆ°åˆ†ç»„')
              .fontSize(14)
              .fontColor('#FFFFFF')
              .backgroundColor('#007AFF')
              .borderRadius(8)
              .padding({ left: 16, right: 16, top: 8, bottom: 8 })
              .enabled(this.multiSelectState.selectedRecords.size > 0)
              .onClick(() => this.showGroupSelectionDialogMethod())
          }
          .width('100%')
          .height(60)
          .padding({ left: 16, right: 16 })
          .backgroundColor('#FFFFFF')
          .border({ width: { top: 0.5 }, color: '#E5E5E5' })
        }

        // åº•éƒ¨å½•éŸ³æŒ‰é’®
        Row() {
          Button() {
            Image($r('app.media.record'))
              .width(50)
              .height(50)
              .fillColor('#FFFFFF')
          }
          .width(70)
          .height(70)
          .backgroundColor('#007AFF')
          .borderRadius(40)
          .onClick(() => this.navigateToRecord())
        }
        .width('100%')
        .height(80)
        .justifyContent(FlexAlign.Center)
        .alignItems(VerticalAlign.Center)
        .backgroundColor('#FFFFFF')
      }
      .width('100%')
      .height('100%')

      // Tabé•¿æŒ‰èœå•ï¼ˆå±…ä¸­æ˜¾ç¤ºçš„å¯¹è¯æ¡†æ ·å¼ï¼‰
      if (this.showTabContextMenu) {
        Stack() {
          // åŠé€æ˜èƒŒæ™¯é®ç½©
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0, 0, 0, 0.4)')
            .onClick(() => {
              hilog.info(DOMAIN, 'Index', 'ç‚¹å‡»é®ç½©å…³é—­èœå•');
              this.showTabContextMenu = false;
            })
          
          // èœå•å†…å®¹
          Column() {
            Text(`åˆ†ç»„: ${this.selectedTabForAction?.name || ''}`)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .width('100%')
              .textAlign(TextAlign.Center)
              .padding({ top: 16, bottom: 12 })
            
            Divider()
              .color('#E5E5E5')
            
            Button('é‡å‘½å')
              .fontSize(16)
              .fontColor('#333333')
              .backgroundColor('#FFFFFF')
              .width('100%')
              .height(50)
              .onClick(() => this.showRenameGroupDialogMethod())
            
            Divider()
              .color('#E5E5E5')
            
            Button('åˆ é™¤')
              .fontSize(16)
              .fontColor('#FF3B30')
              .backgroundColor('#FFFFFF')
              .width('100%')
              .height(50)
              .onClick(() => this.deleteGroup())
            
            Divider()
              .color('#E5E5E5')
              .strokeWidth(8)
            
            Button('å–æ¶ˆ')
              .fontSize(16)
              .fontColor('#007AFF')
              .backgroundColor('#FFFFFF')
              .width('100%')
              .height(50)
              .onClick(() => {
                this.showTabContextMenu = false;
              })
          }
          .width('80%')
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .shadow({ radius: 16, color: 'rgba(0,0,0,0.3)' })
        }
        .width('100%')
        .height('100%')
      }

      // é€‰æ‹©åˆ†ç»„å¼¹çª—
      if (this.showGroupSelectionDialog) {
        Column() {
          Text('é€‰æ‹©åˆ†ç»„')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .margin({ bottom: 20 })
          
          List() {
            ForEach(this.audioGroups, (group: AudioGroup) => {
              ListItem() {
                Text(group.groupName)
                  .fontSize(16)
                  .fontColor('#333333')
                  .width('100%')
                  .height(44)
                  .textAlign(TextAlign.Start)
                  .onClick(() => this.selectExistingGroup(group.id))
              }
            })
            
            ListItem() {
              Text('+ åˆ›å»ºæ–°åˆ†ç»„')
                .fontSize(16)
                .fontColor('#007AFF')
                .width('100%')
                .height(44)
                .textAlign(TextAlign.Start)
                .onClick(() => {
                  this.showGroupSelectionDialog = false;
                  this.showCreateGroupDialog = true;
                })
            }
          }
          .width('100%')
          .height(200)
          
          Button('å–æ¶ˆ')
            .fontSize(16)
            .fontColor('#666666')
            .backgroundColor('#F5F5F5')
            .width('100%')
            .height(44)
            .margin({ top: 20 })
            .onClick(() => {
              this.showGroupSelectionDialog = false;
            })
        }
        .width('80%')
        .padding(20)
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
        .shadow({ radius: 12, color: 'rgba(0,0,0,0.2)' })
        .position({ x: '10%', y: '30%' })
      }

      // åˆ›å»ºæ–°åˆ†ç»„å¼¹çª—
      if (this.showCreateGroupDialog) {
        Column() {
          Text('åˆ›å»ºæ–°åˆ†ç»„')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .margin({ bottom: 20 })
          
          TextInput({ placeholder: 'è¯·è¾“å…¥åˆ†ç»„åç§°', text: this.newGroupName })
            .fontSize(16)
            .width('100%')
            .height(44)
            .backgroundColor('#F5F5F5')
            .borderRadius(8)
            .padding({ left: 12, right: 12 })
            .margin({ bottom: 20 })
            .onChange((value: string) => {
              this.newGroupName = value;
            })
          
          Row() {
            Button('å–æ¶ˆ')
              .fontSize(16)
              .fontColor('#666666')
              .backgroundColor('#F5F5F5')
              .width('48%')
              .height(44)
              .onClick(() => {
                this.showCreateGroupDialog = false;
                this.newGroupName = '';
              })
            
            Blank()
            
            Button('åˆ›å»º')
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#007AFF')
              .width('48%')
              .height(44)
              .enabled(this.newGroupName.trim().length > 0)
              .onClick(() => this.createNewGroup())
          }
          .width('100%')
        }
        .width('80%')
        .padding(20)
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
        .shadow({ radius: 12, color: 'rgba(0,0,0,0.2)' })
        .position({ x: '10%', y: '30%' })
      }

      // é‡å‘½ååˆ†ç»„å¼¹çª—
      if (this.showRenameGroupDialog) {
        Column() {
          Text('é‡å‘½ååˆ†ç»„')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .margin({ bottom: 20 })
          
          TextInput({ placeholder: 'è¯·è¾“å…¥æ–°çš„åˆ†ç»„åç§°', text: this.renameGroupName })
            .fontSize(16)
            .width('100%')
            .height(44)
            .backgroundColor('#F5F5F5')
            .borderRadius(8)
            .padding({ left: 12, right: 12 })
            .margin({ bottom: 20 })
            .onChange((value: string) => {
              this.renameGroupName = value;
            })
          
          Row() {
            Button('å–æ¶ˆ')
              .fontSize(16)
              .fontColor('#666666')
              .backgroundColor('#F5F5F5')
              .width('48%')
              .height(44)
              .onClick(() => {
                this.showRenameGroupDialog = false;
                this.renameGroupName = '';
                this.selectedTabForAction = null;
              })
            
            Blank()
            
            Button('ç¡®å®š')
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#007AFF')
              .width('48%')
              .height(44)
              .enabled(this.renameGroupName.trim().length > 0)
              .onClick(() => this.renameGroup())
          }
          .width('100%')
        }
        .width('80%')
        .padding(20)
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
        .shadow({ radius: 12, color: 'rgba(0,0,0,0.2)' })
        .position({ x: '10%', y: '30%' })
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  AudioRecordItemBuilder(audioRecord: AudioRecord) {
    Row() {
      if (this.multiSelectState.isMultiSelectMode) {
        Button()
        .width(24)
        .height(24)
        .padding(0)
        .backgroundColor(this.multiSelectState.selectedRecords.has(audioRecord.id) ? '#007AFF' : 'transparent')
        .border({ width: 2, color: '#007AFF' })
        .borderRadius(12)
        .margin({ right: 12 })
        .onClick(() => this.toggleRecordSelection(audioRecord.id))
      } else {
        // ç§»é™¤æŒ‰é’®ç»„ä»¶ï¼Œä¿æŒå¸ƒå±€é—´è·
        Row()
        .width(12)
        .height(12)
        .margin({ right: 12 })
      }

      Column() {
        Row() {
          Text(audioRecord.fileName)
            .fontSize(16)
            .fontColor('#333333')
            .fontWeight(FontWeight.Medium)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .layoutWeight(1)
          
          if (audioRecord.isTop) {
            Text('ç½®é¡¶')
              .fontSize(10)
              .fontColor('#FF6B35')
              .backgroundColor('#FFF3E0')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(8)
              .margin({ left: 8 })
          }
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)

        Row() {
          Text(this.formatDuration(audioRecord.duration))
            .fontSize(12)
            .fontColor('#999999')
          
          Text('â€¢')
            .fontSize(12)
            .fontColor('#999999')
            .margin({ left: 8, right: 8 })
          
          Text(this.formatFileSize(audioRecord.fileSize))
            .fontSize(12)
            .fontColor('#999999')
          
          Blank()
          
          Text(this.formatCreateTime(audioRecord.createTime))
            .fontSize(12)
            .fontColor('#999999')
        }
        .width('100%')
        .margin({ top: 4 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor('#FFFFFF')
    .onClick(() => {
      if (this.multiSelectState.isMultiSelectMode) {
        this.toggleRecordSelection(audioRecord.id);
      } else {
        this.navigateToAudioDetail(audioRecord);
      }
    })
    .gesture(
      LongPressGesture({ repeat: false })
        .onAction(() => {
          if (!this.multiSelectState.isMultiSelectMode) {
            hilog.info(DOMAIN, 'Index', `é•¿æŒ‰éŸ³é¢‘é¡¹è¿›å…¥å¤šé€‰æ¨¡å¼: ${audioRecord.fileName}`);
            this.enterMultiSelectMode(audioRecord.id);
          }
        })
    )
  }

  @Builder
  SwipeActionsBuilder(audioRecord: AudioRecord) {
    Row() {
      Button(audioRecord.isTop ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶')
        .fontSize(14)
        .fontColor('#FFFFFF')
        .backgroundColor('#FF9500')
        .width(80)
        .height('100%')
        .onClick(() => this.toggleTopStatus(audioRecord))
      
      Button('åˆ é™¤')
        .fontSize(14)
        .fontColor('#FFFFFF')
        .backgroundColor('#FF3B30')
        .width(80)
        .height('100%')
        .onClick(async () => {
          try {
            await this.databaseService.deleteAudioRecord(audioRecord.id);
            await this.loadAudioRecords();
          } catch (error) {
            hilog.error(DOMAIN, 'Index', `Failed to delete audio record: ${JSON.stringify(error)}`);
          }
        })
    }
  }

  private loginWithHuaweiID(): void {
    const loginRequest = new authentication.HuaweiIDProvider().createLoginWithHuaweiIDRequest();
    loginRequest.forceLogin = false;
    const controller = new authentication.AuthenticationController();
    controller.executeRequest(loginRequest).then((data: authentication.LoginWithHuaweiIDResponse) => {
      const loginWithHuaweiIDResponse = data;
      const authCode = loginWithHuaweiIDResponse.data?.authorizationCode;
    }).catch((error: BusinessError) => {
      hilog.error(DOMAIN, 'testTag', 'error: %{public}s', JSON.stringify(error));
      if (error.code === authentication.AuthenticationErrorCode.ACCOUNT_NOT_LOGGED_IN) {
        // HUAWEI ID is not logged in
      }
    });
  }
}